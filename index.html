<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Van Dort Letselschade Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        // Firebase SDKs worden hier Ã©Ã©n keer correct geÃ¯mporteerd.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, serverTimestamp, arrayUnion, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Expose Firebase modules to the window object for easy access
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
            getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, serverTimestamp, arrayUnion, where, writeBatch,
            getDatabase, ref, onValue, set, onDisconnect, rtdbServerTimestamp,
            getStorage, storageRef, uploadBytes, getDownloadURL
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f9; }
        .bg-primary { background-color: #0E3190; }
        .text-primary { color: #0E3190; }
        .border-primary { border-color: #0E3190; }
        .hover\:bg-primary-dark:hover { background-color: #0A246A; }
        .bg-accent { background-color: #19AACD; }
        .text-accent { color: #19AACD; }
        .border-accent { border-color: #19AACD; }
        .bg-subtle { background-color: #F8FBFC; }
        .readonly-input { background-color: #e9ecef; opacity: 0.7; cursor: not-allowed; }
        .disabled-section { opacity: 0.6; pointer-events: none; }
        .invalid-input { border-color: #ef4444; box-shadow: 0 0 0 1px #ef4444; }
        #notification {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500;
            z-index: 1050; transition: opacity 0.5s, transform 0.5s;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-backdrop { z-index: 1040; }
        .modal { z-index: 1050; }

        /* Schadestaat Specifieke Stijlen */
        .drag-handle { cursor: move; }
        .sortable-ghost { opacity: 0.4; background-color: #A4DFEB; }
        .schadepost-hoofd { border-bottom: 2px solid #e5e7eb; padding-bottom: 1rem; }
        .sub-regel { background-color: #f9fafb; border-left: 3px solid #19AACD; }
        .border-validation-error { border-color: #E53E3E; }
        .border-validation-warning { border-color: #F6AD55; }
        .validation-panel { background: linear-gradient(135deg, #FED7D7 0%, #FEE2E2 100%); }
        .validation-item { background: rgba(255,255,255,0.7); }

        /* Jurisprudentie Specifieke Stijlen */
        .result-item-selected {
            background-color: #EBF8FF !important;
            border-color: #19AACD !important;
        }
        details > summary {
            cursor: pointer;
            list-style: none; /* Verwijder standaard pijl */
        }
        details > summary::-webkit-details-marker {
            display: none; /* Verwijder standaard pijl in Chrome */
        }
        details > summary::before {
            content: 'â–º';
            margin-right: 0.5rem;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
        .filter-checkbox-group {
            column-count: 2;
        }
        @media (max-width: 768px) {
            .filter-checkbox-group {
                column-count: 1;
            }
        }
        #jurisprudentie-loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #19AACD;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container">

        <div id="hub-page">
            <div class="flex flex-col min-h-screen">
                <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
                    <div class="flex items-center">
                        <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                        <div>
                            <h1 class="text-2xl font-bold text-primary">Kantoor Hub</h1>
                            <p class="text-sm text-gray-500">Uw centrale startpunt</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-medium">Ingelogd als:</span>
                        <select id="user-selector" class="text-sm font-bold border-gray-300 rounded-md shadow-sm"></select>
                    </div>
                </header>
                <main class="flex-grow p-4 md:p-6 lg:p-8">
                    <div class="w-full max-w-7xl mx-auto space-y-8">
                        
                        <div class="flex flex-col lg:flex-row gap-8">
                            <div id="daily-briefing-widget" class="bg-white p-6 rounded-lg shadow-xl lg:w-1/2">
                                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Mijn Dagoverzicht</h2>
                                <div id="daily-briefing-container" class="space-y-3"></div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col lg:w-1/2">
                                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Team Prikbord</h2>
                                <p class="text-gray-600 mb-6 flex-grow">Centrale plek voor mededelingen, vragen en memo's.</p>
                                <div class="space-y-3 mb-6">
                                    <div class="flex justify-between items-center"><span class="font-medium">Nieuwe berichten voor u:</span><span id="hub-prikbord-private-messages" class="font-bold px-3 py-1 rounded-full">0</span></div>
                                </div>
                                <button id="btn-go-to-prikbord" class="mt-auto w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-sm">Ga naar Prikbord &rarr;</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col">
                                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Mijn Deadlines</h2>
                                <p class="text-gray-600 mb-6 flex-grow">Beheer en stel deadlines voor teamleden.</p>
                                <div class="space-y-3 mb-6">
                                    <div class="flex justify-between items-center"><span class="font-medium">Openstaande Deadlines:</span><span id="hub-deadlines-open" class="font-bold px-3 py-1 rounded-full">0</span></div>
                                </div>
                                <button id="btn-go-to-deadlines" class="mt-auto w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-sm">Beheer Deadlines &rarr;</button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col">
                                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Derdengeld Verantwoording</h2>
                                <p class="text-gray-600 mb-6 flex-grow">Beheer en verantwoord de derdengelden.</p>
                                <div class="space-y-3 mb-6">
                                    <div class="flex justify-between items-center"><span class="font-medium">Mijn Goedkeuringen:</span><span id="hub-derdengeld-approvals" class="font-bold px-3 py-1 rounded-full">0</span></div>
                                    <div class="flex justify-between items-center"><span class="font-medium">Mijn Openstaande Taken:</span><span id="hub-derdengeld-tasks" class="font-bold px-3 py-1 rounded-full">0</span></div>
                                </div>
                                <button id="btn-go-to-derdengeld" class="mt-auto w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-sm">Open Derdengeld App &rarr;</button>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col">
                                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Schadestaten</h2>
                                <div class="relative mb-4">
                                    <input type="search" id="schadestaat-widget-search" placeholder="Zoek dossiernummer..." class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                    </div>
                                </div>
                                <div id="schadestaten-widget-list" class="space-y-2 flex-grow mb-4 h-32 overflow-y-auto">
                                </div>
                                <button id="btn-new-schadestaat" class="mt-auto w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-sm">Schadestaat Toevoegen &rarr;</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="bg-white p-6 rounded-lg shadow-xl">
                                    <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Aanwezigheid Team</h2>
                                    <div id="presence-container" class="flex flex-wrap gap-x-8 gap-y-4"></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg shadow-xl">
                                    <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Handige Links</h2>
                                    <div id="quick-links-container" class="space-y-3"></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col">
                                 <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Standaard Documenten</h2>
                                 <p class="text-gray-600 mb-6 flex-grow">Vind en download de benodigde formulieren en formats.</p>
                                 <div class="space-y-3 mb-6">
                                     <div class="flex justify-between items-center"><span class="font-medium">Totaal Documenten:</span><span id="hub-docs-total" class="font-bold px-3 py-1 rounded-full">0</span></div>
                                 </div>
                                 <button id="btn-go-to-docs" class="mt-auto w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-sm">Open Documenten &rarr;</button>
                             </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col">
                                <h2 class="text-xl font-bold text-primary mb-4 border-b pb-2">Jurisprudentie Zoeker</h2>
                                <p class="text-gray-600 mb-6 flex-grow">Doorzoek direct de live Rechtspraak.nl database.</p>
                                <div class="space-y-3 mb-6">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">GeÃ¯ntegreerde Bron:</span>
                                        <span class="font-bold px-3 py-1 rounded-full bg-blue-100 text-blue-800">Rechtspraak.nl</span>
                                    </div>
                                </div>
                                <button id="btn-go-to-jurisprudentie" class="mt-auto w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-sm">
                                    Start Rolfies Superzoeker &rarr;
                                </button>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="prikbord-page" class="hidden"></div>
    <div id="derdengeld-app-container" class="hidden"></div>
    <div id="deadlines-page" class="hidden"></div>
    <div id="docs-page" class="hidden"></div>
    <div id="schadestaat-page" class="hidden"></div>
    
    <div id="jurisprudentie-page" class="hidden">
        <div class="flex flex-col h-screen bg-subtle">
            <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10 shrink-0">
                <div class="flex items-center">
                    <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                    <div>
                        <h1 class="text-2xl font-bold text-primary">Rolfies Superzoeker</h1>
                        <p class="text-sm text-gray-500">Live Jurisprudentie Navigator</p>
                    </div>
                </div>
                <button class="btn-back-to-hub text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Hub</button>
            </header>

            <main class="flex-grow grid grid-cols-12 gap-4 p-4 overflow-hidden">

                <aside class="col-span-12 lg:col-span-3 bg-white rounded-lg shadow-lg flex flex-col h-full overflow-hidden">
                    <div class="p-4 border-b">
                        <h2 class="text-lg font-semibold text-primary">Zoekopdracht</h2>
                    </div>
                    <div id="jurisprudentie-form" class="p-4 space-y-4 overflow-y-auto">
                        <div>
                            <label for="jurisprudentie-omnibox" class="text-sm font-medium text-gray-700">Zoekterm</label>
                            <textarea id="jurisprudentie-omnibox" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary" placeholder="Voer trefwoorden in..."></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div><label for="filter-date-start" class="text-sm font-medium">Datum na:</label><input type="date" id="filter-date-start" class="mt-1 w-full rounded-md border-gray-300 text-sm"></div>
                            <div><label for="filter-date-end" class="text-sm font-medium">Datum voor:</label><input type="date" id="filter-date-end" class="mt-1 w-full rounded-md border-gray-300 text-sm"></div>
                        </div>

                        <details id="filter-details-instances" class="border-t pt-4">
                            <summary class="font-semibold text-gray-800">Instanties</summary>
                            <div class="mt-2 space-y-2 pl-2 filter-checkbox-group">
                                </div>
                        </details>

                        <details id="filter-details-law-areas" class="border-t pt-4">
                            <summary class="font-semibold text-gray-800">Rechtsgebieden</summary>
                            <div class="mt-2 space-y-2 pl-2 filter-checkbox-group">
                                </div>
                        </details>
                    </div>
                    <div class="mt-auto p-4 border-t bg-gray-50">
                        <button id="jurisprudentie-search-button" class="w-full bg-accent hover:bg-opacity-90 text-white font-bold py-3 rounded-lg shadow-sm">Zoeken</button>
                    </div>
                </aside>

                <section class="col-span-12 lg:col-span-4 bg-white rounded-lg shadow-lg flex flex-col h-full overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-primary">Resultaten (<span id="jurisprudentie-result-count">0</span>)</h2>
                        <div class="text-sm text-gray-400">
                            Standaard sortering
                        </div>
                    </div>
                    <div class="flex-grow relative">
                        <div id="jurisprudentie-results-list" class="absolute inset-0 overflow-y-auto p-2 space-y-2">
                            <div class="flex items-center justify-center h-full text-center p-10 text-gray-500">
                                Voer een zoekopdracht in om te beginnen.
                            </div>
                        </div>
                        <div id="jurisprudentie-loader-container" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center">
                            <div id="jurisprudentie-loader"></div>
                        </div>
                    </div>
                    <div id="jurisprudentie-pagination" class="p-2 border-t flex justify-between items-center text-sm">
                        <button id="pagination-prev" class="px-4 py-2 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">&larr; Vorige</button>
                        <span id="pagination-info" class="text-gray-600"></span>
                        <button id="pagination-next" class="px-4 py-2 rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">Volgende &rarr;</button>
                    </div>
                </section>

                <article class="col-span-12 lg:col-span-5 bg-white rounded-lg shadow-lg flex flex-col h-full overflow-hidden">
                    <div id="jurisprudentie-detail-pane-placeholder" class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-8">
                       <svg class="h-12 w-12 text-gray-300 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" /></svg>
                        <h3 class="font-semibold text-lg text-gray-700">Selecteer een uitspraak</h3>
                        <p>Klik op een resultaat in de lijst om hier de details te bekijken.</p>
                    </div>
                    <div id="jurisprudentie-detail-pane-content" class="hidden flex-col h-full">
                        <div class="border-b border-gray-200">
                            <nav id="jurisprudentie-detail-tabs" class="-mb-px flex space-x-6 px-4" aria-label="Tabs">
                            </nav>
                        </div>
                        <div id="jurisprudentie-detail-tab-content" class="p-4 overflow-y-auto">
                        </div>
                    </div>
                </article>
            </main>
        </div>
    </div>
    
    <div id="notification" class="hidden"></div>
    <div id="modal-container"></div>

    <script type="module">
    // --- FIREBASE & GLOBALE CONFIGURATIE ---

    // 1. Haal de Firebase modules op die in de <head> zijn geÃ«xporteerd.
    const { 
        initializeApp, getAuth, signInAnonymously, onAuthStateChanged,
        getFirestore, doc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, query, serverTimestamp, arrayUnion, where, writeBatch,
        getDatabase, ref, onValue, set, onDisconnect, rtdbServerTimestamp,
        getStorage, storageRef, uploadBytes, getDownloadURL 
    } = window.firebase;
    
    // 2. Jouw unieke project sleutels (deze zijn correct!)
    const firebaseConfig = {
      apiKey: "AIzaSyDsWX2rv9RlFHUpZe4TVPZxPoi7CchQd0A",
      authDomain: "vdl-hub.firebaseapp.com",
      projectId: "vdl-hub",
      storageBucket: "vdl-hub.appspot.com",
      messagingSenderId: "1002801206953",
      appId: "1:1002801206953:web:a6d81eed27a0bb641dfbb8",
      measurementId: "G-5ZF5L22ZRZ"
    };

    // 3. Initialiseer Firebase en alle benodigde services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);
    const storage = getStorage(app);
    
    // --- GLOBALE STAAT & CONSTANTEN ---
    const COLLEAGUES = ['Ine van Dort', 'Rolf van Dort', 'Maaike', 'Esther', 'Simone', 'Sandra'];
    const QUICK_LINKS = [
        { name: 'ANWB Routeplanner', url: 'https://www.anwb.nl/verkeer/routeplanner' },
        { name: 'NIS', url: 'https://nis.letselschaderaad.nl/' },
        { name: 'Rechtspraak.nl', url: 'https://www.rechtspraak.nl/' },
    ];
    let currentUserDisplayName = COLLEAGUES[0];
    let currentUserId = null;
    let currentOpenMessageId = null;
    let currentSchadestaatId = null;
    
    let allMessages = [];
    let allDeadlines = [];
    let standardDocuments = [];
    let allSchadestaten = [];
    let unsubscribers = [];

    // --- AANWEZIGHEIDSSYSTEEM (REAL-TIME) ---
    function setupPresenceSystem() {
        if (!currentUserId || !currentUserDisplayName) return;

        const userStatusDatabaseRef = ref(rtdb, `/status/${currentUserDisplayName}`);
        const infoConnectedRef = ref(rtdb, '.info/connected');

        onValue(infoConnectedRef, (snapshot) => {
            if (snapshot.val() === false) {
                return; // Gebruiker is niet verbonden
            }
            
            onDisconnect(userStatusDatabaseRef).set({
                state: 'offline',
                last_changed: rtdbServerTimestamp()
            }).then(() => {
                set(userStatusDatabaseRef, {
                    state: 'online',
                    last_changed: rtdbServerTimestamp()
                });
            });
        });

        const statusRef = ref(rtdb, 'status/');
        onValue(statusRef, (snapshot) => {
            const statuses = snapshot.val() || {};
            renderPresence(statuses);
        });
    }

    function renderPresence(statuses) {
        const container = document.getElementById('presence-container');
        if (!container) return;
        const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);

        container.innerHTML = COLLEAGUES.map(colleague => {
            const userStatus = statuses[colleague];
            const isPresent = userStatus && userStatus.state === 'online';
            const statusClass = isPresent ? 'bg-green-500' : 'bg-gray-400';
            const textClass = isPresent ? 'text-gray-800' : 'text-gray-500';
            return `<div class="flex items-center gap-2"><span class="h-3 w-3 rounded-full ${statusClass}"></span><span class="${textClass}">${colleague}</span></div>`;
        }).join('');
    }

    // --- UTILITY FUNCTIES ---
    function sanitizeInput(text) {
        if (typeof text !== 'string') return '';
        const temp = document.createElement('div');
        temp.textContent = text;
        return temp.innerHTML;
    }

    function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }
    }

    function showBrowserNotification(title, body) {
        if (Notification.permission === "granted") {
            new Notification(title, { body });
        }
    }

    function parseAndStyleMentions(text) {
        if (!text) return '';
        text = sanitizeInput(text);
        const colleaguesRegex = new RegExp(`@(${COLLEAGUES.join('|')})`, 'g');
        return text.replace(colleaguesRegex, `<strong class="bg-blue-100 text-blue-800 px-1 rounded">$&</strong>`);
    }

    // --- INITIALISATIE VAN DE APP ---
    document.addEventListener('DOMContentLoaded', () => {
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                initializeApplication();
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Anoniem inloggen mislukt:", error);
                    showNotification('Kon niet verbinden met de server.', 'error');
                });
            }
        });
    });

    function initializeApplication() {
        setupUserSelector();
        initFirestoreListeners();
        setupPresenceSystem(); // Eerste aanroep
        initializeDerdengeldApp();
        initializeSchadestaatApp();
        setupEventListeners();
        showPage('hub-page');
        requestNotificationPermission();
    }
    
    function setupUserSelector() {
        const selector = document.getElementById('user-selector');
        selector.innerHTML = COLLEAGUES.map(name => `<option value="${name}" ${name === currentUserDisplayName ? 'selected' : ''}>${name}</option>`).join('');
        selector.addEventListener('change', (e) => {
            currentUserDisplayName = e.target.value;
            if (window.derdengeldApp) window.derdengeldApp.setCurrentUser(currentUserDisplayName);
            updateDashboard();
            if (document.getElementById('prikbord-page').style.display !== 'none') renderPrikbord();
            if (document.getElementById('deadlines-page').style.display !== 'none') renderDeadlinesPage();
            if (document.getElementById('docs-page').style.display !== 'none') renderDocsPage();
            setupPresenceSystem(); // Opnieuw aanroepen na gebruikerwissel
        });
    }

    function initFirestoreListeners() {
        unsubscribers.forEach(unsub => unsub());
        unsubscribers = [];

        const messagesQuery = query(collection(db, "messages"));
        const unsubMessages = onSnapshot(messagesQuery, (querySnapshot) => {
            allMessages = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.getElementById('prikbord-page').style.display !== 'none') renderMessages();
            if (currentOpenMessageId) renderMessageDetailModal(currentOpenMessageId);
            updateDashboard();
        });
        unsubscribers.push(unsubMessages);

        const deadlinesQuery = query(collection(db, "deadlines"));
        const unsubDeadlines = onSnapshot(deadlinesQuery, (querySnapshot) => {
            allDeadlines = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.getElementById('deadlines-page').style.display !== 'none') renderAllDeadlines();
            updateDashboard();
        });
        unsubscribers.push(unsubDeadlines);

        const docsQuery = query(collection(db, "documents"));
        const unsubDocs = onSnapshot(docsQuery, (querySnapshot) => {
            standardDocuments = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (document.getElementById('docs-page').style.display !== 'none') renderAllDocuments();
            updateDashboard();
        });
        unsubscribers.push(unsubDocs);

        const schadestatenQuery = query(collection(db, "schadestaten"));
        const unsubSchadestaten = onSnapshot(schadestatenQuery, (querySnapshot) => {
            allSchadestaten = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSchadestatenWidget();
        });
        unsubscribers.push(unsubSchadestaten);
    }

    // --- NAVIGATIE ---
    const allPages = ['hub-page', 'prikbord-page', 'derdengeld-app-container', 'deadlines-page', 'docs-page', 'schadestaat-page', 'jurisprudentie-page'];

    function showPage(pageId, context = null) {
        allPages.forEach(p => document.getElementById(p)?.classList.add('hidden'));
        document.getElementById(pageId)?.classList.remove('hidden');
        
        const pageActions = {
            'hub-page': () => updateDashboard(),
            'prikbord-page': () => renderPrikbord(),
            'deadlines-page': () => renderDeadlinesPage(),
            'docs-page': () => renderDocsPage(),
            'jurisprudentie-page': () => initializeJurisprudentieApp(),
            'schadestaat-page': () => {
                if (window.schadestaatApp) {
                    window.schadestaatApp.loadState(context?.id || null);
                }
            }
        };
        pageActions[pageId]?.();
    }

    function showDerdengeldPage(pageId) {
        showPage('derdengeld-app-container');
        const derdengeldPages = ['derdengeld-dashboard-page', 'derdengeld-new-form-page', 'derdengeld-task-view-page', 'derdengeld-report-page'];
        derdengeldPages.forEach(p => document.getElementById(p)?.classList.add('hidden'));
        document.getElementById(pageId)?.classList.remove('hidden');
        if (pageId === 'derdengeld-dashboard-page' && window.derdengeldApp) {
            window.derdengeldApp.renderDashboard();
        }
    }

    // --- HUB LOGICA & RENDERING ---
    function updateDashboard() {
        updateHubTileWidgets();
        renderDailyBriefingWidget();
        renderQuickLinksWidget();
    }

    function updateHubTileWidgets() {
        const setBadge = (elementId, value, alwaysGray = false) => {
            const badge = document.getElementById(elementId);
            if (!badge) return;
            badge.textContent = value;
            badge.className = 'font-bold px-3 py-1 rounded-full';

            const colorClasses = {
                'hub-prikbord-private-messages': ['bg-blue-100', 'text-blue-800'],
                'hub-deadlines-open': ['bg-red-100', 'text-red-800'],
                'hub-derdengeld-approvals': ['bg-yellow-100', 'text-yellow-800'],
                'hub-derdengeld-tasks': ['bg-blue-100', 'text-blue-800'],
                'hub-docs-total': ['bg-gray-100', 'text-gray-800']
            };
            
            if (value > 0 && !alwaysGray) {
                badge.classList.add(...colorClasses[elementId]);
            } else {
                badge.classList.add('bg-gray-100', 'text-gray-800');
            }
        };

        const unreadPrivateMessages = allMessages.filter(m => m.isPrivate && m.recipients.includes(currentUserDisplayName) && !(m.readBy?.includes(currentUserDisplayName))).length;
        setBadge('hub-prikbord-private-messages', unreadPrivateMessages);

        if (window.derdengeldApp) {
            const stats = window.derdengeldApp.getStats();
            setBadge('hub-derdengeld-approvals', stats.approvals);
            setBadge('hub-derdengeld-tasks', stats.myTasks);
        }

        const deadlineStats = getDeadlineStats();
        setBadge('hub-deadlines-open', deadlineStats.open);
        
        setBadge('hub-docs-total', standardDocuments.length, true);
    }

    function renderQuickLinksWidget() {
        const container = document.getElementById('quick-links-container');
        if (!container) return;
        container.innerHTML = QUICK_LINKS.map(link => `
            <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                <span class="text-primary font-medium">${link.name}</span>
            </a>
        `).join('');
    }

    function renderDailyBriefingWidget() {
        const container = document.getElementById('daily-briefing-container');
        if(!container) return;

        const briefingItems = [];
        const unreadPrikbord = allMessages.filter(m => m.isPrivate && m.recipients.includes(currentUserDisplayName) && !(m.readBy?.includes(currentUserDisplayName))).length;
        if (unreadPrikbord > 0) briefingItems.push({ text: `U heeft <strong>${unreadPrikbord}</strong> nieuwe privÃ©berichten.`, actionId: 'btn-go-to-prikbord' });

        if (window.derdengeldApp) {
            const derdengeldStats = window.derdengeldApp.getStats();
            if (derdengeldStats.approvals > 0) briefingItems.push({ text: `Er wachten <strong>${derdengeldStats.approvals}</strong> verzoeken op uw goedkeuring.`, actionId: 'btn-go-to-derdengeld' });
            if (derdengeldStats.myTasks > 0) briefingItems.push({ text: `U heeft <strong>${derdengeldStats.myTasks}</strong> openstaande derdengeld taken.`, actionId: 'btn-go-to-derdengeld' });
        }

        const deadlineStats = getDeadlineStats();
        if (deadlineStats.open > 0) briefingItems.push({ text: `U heeft <strong>${deadlineStats.open}</strong> openstaande deadlines.`, actionId: 'btn-go-to-deadlines' });
        
        if (briefingItems.length === 0) {
            container.innerHTML = `<p class="text-gray-500">Geen openstaande actiepunten. Een rustige dag!</p>`;
        } else {
            container.innerHTML = briefingItems.map(item => `
                <div class="flex items-center gap-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer briefing-item" data-action-id="${item.actionId}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>${item.text}</span>
                </div>
            `).join('');
        }
    }

    function renderSchadestatenWidget(filterText = '') {
        const container = document.getElementById('schadestaten-widget-list');
        if (!container) return;

        const lowerCaseFilter = filterText.toLowerCase();
        const filtered = allSchadestaten.filter(item => item.data?.algemeen?.dossiernummer.toLowerCase().includes(lowerCaseFilter));
        const sorted = [...filtered].sort((a, b) => (b.lastModified?.seconds || 0) - (a.lastModified?.seconds || 0));
        
        if (sorted.length === 0) {
            container.innerHTML = `<p class="text-sm text-gray-500 text-center">${filterText ? 'Geen resultaten.' : 'Nog geen schadestaten.'}</p>`;
        } else {
            container.innerHTML = sorted.map(item => {
                const dossiernummer = item.data.algemeen?.dossiernummer || 'Onbekend';
                const date = item.lastModified?.seconds ? new Date(item.lastModified.seconds * 1000).toLocaleDateString('nl-NL', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Onbekend';
                return `
                    <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer schadestaat-widget-item" data-id="${item.id}">
                        <p class="font-semibold text-primary">${dossiernummer}</p>
                        <p class="text-xs text-gray-500">Laatst bewerkt: ${date}</p>
                    </div>`;
            }).join('');
        }
    }

    // --- MODAL FUNCTIES ---
    function openModal(innerHTML) {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `<div class="modal-backdrop fixed inset-0 bg-gray-800 bg-opacity-75"></div><div class="modal fixed inset-0 flex items-center justify-center p-4">${innerHTML}</div>`;
    }

    function closeModal() {
        currentOpenMessageId = null;
        document.getElementById('modal-container').innerHTML = '';
    }
    
    // --- PRIKBORD ---
    function renderPrikbord() {
        const container = document.getElementById('prikbord-page');
        container.innerHTML = `
            <div class="flex flex-col h-screen">
                <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10 shrink-0">
                    <div class="flex items-center">
                        <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                        <div><h1 class="text-2xl font-bold text-primary">Team Prikbord</h1><p class="text-sm text-gray-500">Mededelingen, vragen en memo's</p></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="btn-back-to-hub text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Hub</button>
                        <button id="btn-new-message" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-sm">+ Nieuw Bericht</button>
                    </div>
                </header>
                <main class="flex-grow p-4 md:p-6 lg:p-8 grid grid-cols-12 gap-6 overflow-hidden">
                    <div class="col-span-12 md:col-span-3 bg-white p-4 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold mb-4 border-b pb-2">Filters</h2>
                        <div class="space-y-4">
                            <div><label for="filter-search" class="text-sm font-medium">Zoeken</label><input type="text" id="filter-search" placeholder="Zoek op trefwoord..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                            <div><label for="filter-priority" class="text-sm font-medium">Prioriteit</label><select id="filter-priority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"><option value="all">Alles</option><option>Hoog</option><option>Normaal</option><option>Laag</option></select></div>
                            <div><label for="filter-user" class="text-sm font-medium">Geadresseerd aan</label><select id="filter-user" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"><option value="all">Iedereen</option>${COLLEAGUES.map(u => `<option value="${u}">${u}</option>`).join('')}</select></div>
                        </div>
                    </div>
                    <div id="prikbord-grid" class="col-span-12 md:col-span-9 overflow-y-auto no-scrollbar space-y-4"></div>
                </main>
            </div>`;
        renderMessages();
    }
    function renderMessages() {
        const grid = document.getElementById('prikbord-grid');
        if (!grid) return;
        const searchTerm = document.getElementById('filter-search').value.toLowerCase();
        const filterPriority = document.getElementById('filter-priority').value;
        const filterUser = document.getElementById('filter-user').value;
        
        const sorted = [...allMessages].sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
        
        const filtered = sorted.filter(m => {
            const isVisible = !m.isPrivate || m.author === currentUserDisplayName || m.recipients?.includes(currentUserDisplayName);
            const matchesSearch = !searchTerm || m.title.toLowerCase().includes(searchTerm) || m.content.toLowerCase().includes(searchTerm);
            const matchesPriority = filterPriority === 'all' || m.priority === filterPriority;
            const matchesUser = filterUser === 'all' || !m.isPrivate || (m.isPrivate && m.recipients?.includes(filterUser));
            return isVisible && matchesSearch && matchesPriority && matchesUser;
        });
        grid.innerHTML = filtered.length ? filtered.map(createMessageCard).join('') : `<div class="text-center p-10 bg-white rounded-lg shadow"><p class="text-gray-500">Geen berichten gevonden.</p></div>`;
    }
    function createMessageCard(msg) {
        const priorityColors = {'Hoog': 'border-red-500', 'Normaal': 'border-yellow-500', 'Laag': 'border-blue-500'};
        let visibilityInfo = msg.isPrivate ? `ðŸ”’ PrivÃ© aan: ${msg.recipients.map(sanitizeInput).join(', ')}` : `ðŸ‘¥ Voor iedereen`;
        const date = msg.createdAt?.seconds ? new Date(msg.createdAt.seconds * 1000).toLocaleDateString('nl-NL') : 'Zojuist';
        const hasRead = msg.readBy?.includes(currentUserDisplayName);
        const unreadIndicator = !hasRead && (msg.isPrivate ? msg.recipients.includes(currentUserDisplayName) : true) ? '<span class="inline-block h-2 w-2 rounded-full bg-blue-500 ml-2" title="Ongelezen"></span>' : '';
        return `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 ${priorityColors[msg.priority] || 'border-gray-300'} cursor-pointer btn-view-message" data-id="${msg.id}">
                    <div class="flex justify-between items-start">
                        <div><h3 class="font-bold text-lg text-primary pointer-events-none flex items-center">${sanitizeInput(msg.title)} ${unreadIndicator}</h3><p class="text-sm text-gray-500 pointer-events-none">Door: ${sanitizeInput(msg.author)} op ${date}</p></div>
                        <div class="flex items-center gap-2 text-xs font-semibold pointer-events-none"><span class="text-gray-500">${visibilityInfo}</span></div>
                    </div>
                    <p class="mt-3 text-gray-700 truncate pointer-events-none">${sanitizeInput(msg.content)}</p>
                </div>`;
    }
    function renderNewMessageModal(messageId = null) {
        const msg = messageId ? allMessages.find(m => m.id === messageId) : null;
        const isEdit = !!msg;
        const recipientCheckboxes = COLLEAGUES
            .filter(u => u !== currentUserDisplayName)
            .map(u => `<label class="flex items-center space-x-2"><input type="checkbox" name="msg-recipient" value="${u}" class="rounded" ${msg?.recipients?.includes(u) ? 'checked' : ''}><span>${u}</span></label>`)
            .join('');
        const modalHTML = `
            <form id="message-form" data-id="${messageId || ''}" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                <header class="p-4 border-b"><h2 class="text-xl font-semibold text-primary">${isEdit ? 'Bericht Bewerken' : 'Nieuw Bericht'}</h2></header>
                <main class="p-6 space-y-4 overflow-y-auto">
                    <div><label class="block text-sm font-medium">Titel</label><input type="text" id="msg-title" class="mt-1 block w-full rounded-md" value="${msg?.title ? sanitizeInput(msg.title) : ''}" required></div>
                    <div><label class="block text-sm font-medium">Inhoud</label><textarea id="msg-content" rows="5" class="mt-1 block w-full rounded-md" required placeholder="Gebruik @naam om een collega te noemen...">${msg?.content ? sanitizeInput(msg.content) : ''}</textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">Type</label><select id="msg-type" class="mt-1 block w-full rounded-md">${['Memo', 'Vraag', 'Mededeling', 'Belangrijk', 'Probleem'].map(t => `<option ${msg?.type === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                        <div><label class="block text-sm font-medium">Prioriteit</label><select id="msg-priority" class="mt-1 block w-full rounded-md">${['Laag', 'Normaal', 'Hoog'].map(p => `<option ${msg?.priority === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
                    </div>
                    <div><label class="block text-sm font-medium">Zichtbaarheid</label><select id="msg-visibility" class="mt-1 block w-full rounded-md"><option value="public" ${!msg?.isPrivate ? 'selected' : ''}>Voor Iedereen</option><option value="private" ${msg?.isPrivate ? 'selected' : ''}>Voor Specifieke Personen</option></select></div>
                    <div id="recipient-container" class="${!msg?.isPrivate ? 'hidden' : ''}">
                        <label class="block text-sm font-medium mb-2">Ontvangers</label>
                        <div class="grid grid-cols-2 gap-2 p-3 border rounded-md bg-gray-50">${recipientCheckboxes}</div>
                    </div>
                </main>
                <footer class="bg-gray-50 p-4 flex justify-end items-center gap-4 rounded-b-lg shrink-0"><button type="button" class="btn-close-modal text-sm font-medium">Annuleren</button><button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg">Opslaan</button></footer>
            </form>`;
        openModal(modalHTML);
    }
    async function renderMessageDetailModal(messageId) {
        currentOpenMessageId = messageId;
        const msg = allMessages.find(m => m.id === messageId);
        if (!msg) { closeModal(); return; }

        if (!msg.readBy || !msg.readBy.includes(currentUserDisplayName)) {
            const msgRef = doc(db, "messages", messageId);
            await updateDoc(msgRef, {
                readBy: arrayUnion(currentUserDisplayName)
            });
        }
        const canEdit = msg.author === currentUserDisplayName || currentUserDisplayName === 'Ine van Dort';
        
        const sortedComments = (msg.comments || []).sort((a,b) => a.createdAt.seconds - b.createdAt.seconds);

        const commentsHTML = sortedComments.length
            ? sortedComments.map(c => `<div class="bg-gray-100 p-3 rounded-md"><p class="text-sm">${parseAndStyleMentions(c.content)}</p><p class="text-xs text-gray-500 text-right mt-1">- ${sanitizeInput(c.author)} op ${new Date(c.createdAt.seconds * 1000).toLocaleString('nl-NL')}</p></div>`).join('')
            : `<p class="text-sm text-gray-500 text-center py-4">Nog geen reacties.</p>`;
        
        const readByHTML = msg.readBy && msg.readBy.length > 0 ? `<div class="text-sm text-gray-600"><strong>Gezien door:</strong> ${msg.readBy.map(sanitizeInput).join(', ')}</div>` : '';
        const modalHTML = `
            <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl flex flex-col max-h-[90vh]">
                <header class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-semibold text-primary">${sanitizeInput(msg.title)}</h2><button class="btn-close-modal text-gray-400 hover:text-gray-700 text-2xl">&times;</button></header>
                <main class="p-6 flex-grow overflow-y-auto space-y-6">
                    <div class="flex justify-between items-center text-sm">
                        <div><strong>Auteur:</strong> ${sanitizeInput(msg.author)}</div>
                        <div><strong>Datum:</strong> ${new Date(msg.createdAt.seconds * 1000).toLocaleDateString('nl-NL')}</div>
                        <div><strong>Prioriteit:</strong> ${sanitizeInput(msg.priority)}</div>
                    </div>
                    <div class="whitespace-pre-wrap bg-subtle p-4 rounded-md border">${parseAndStyleMentions(msg.content)}</div>
                    ${readByHTML}
                    <div><h3 class="font-semibold mb-2">Reacties</h3><div id="comments-container" class="space-y-2 max-h-64 overflow-y-auto border rounded-md p-2 bg-gray-50">${commentsHTML}</div><form id="comment-form" data-id="${msg.id}" class="mt-4 flex gap-2"><input type="text" id="comment-input" class="flex-grow rounded-md" placeholder="Schrijf een reactie (gebruik @naam)..." required><button type="submit" class="bg-primary text-white px-4 py-2 rounded-md font-medium">Plaats</button></form></div>
                </main>
                <footer class="bg-gray-50 p-4 flex justify-end items-center gap-4 rounded-b-lg">
                    <button type="button" class="btn-close-modal bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-5 rounded-lg">Sluiten</button>
                    ${canEdit ? `<button class="btn-delete-message bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg" data-id="${msg.id}">Verwijderen</button><button class="btn-edit-message bg-primary hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg" data-id="${msg.id}">Bewerken</button>` : ''}
                </footer>
            </div>`;
        openModal(modalHTML);
    }
    async function handleSaveMessage(e) {
        e.preventDefault();
        const form = e.target;
        const messageId = form.dataset.id;
        const titleInput = document.getElementById('msg-title');
        const titleValue = titleInput.value.trim();
        if (!titleValue) {
            showNotification('Titel is een verplicht veld.', 'error');
            titleInput.classList.add('invalid-input');
            return;
        }
        titleInput.classList.remove('invalid-input');
        const isPrivate = document.getElementById('msg-visibility').value === 'private';
        const recipients = Array.from(document.querySelectorAll('input[name="msg-recipient"]:checked')).map(cb => cb.value);
        if (isPrivate && recipients.length === 0) {
            showNotification('Selecteer tenminste Ã©Ã©n ontvanger.', 'error');
            return;
        }
        const messageData = {
            title: titleValue,
            content: document.getElementById('msg-content').value,
            type: document.getElementById('msg-type').value,
            priority: document.getElementById('msg-priority').value,
            isPrivate,
            recipients: isPrivate ? recipients : [],
            author: currentUserDisplayName
        };

        try {
            if (messageId) {
                const msgRef = doc(db, "messages", messageId);
                await updateDoc(msgRef, messageData);
                showNotification('Bericht bijgewerkt!', 'success');
            } else {
                await addDoc(collection(db, "messages"), {
                    ...messageData,
                    createdAt: serverTimestamp(),
                    comments: [],
                    readBy: [currentUserDisplayName]
                });
                showNotification('Bericht geplaatst!', 'success');
            }
            closeModal();
        } catch (error) {
            console.error("Fout bij opslaan bericht:", error);
            showNotification('Kon bericht niet opslaan.', 'error');
        }
    }
    async function handleDeleteMessage(messageId) {
        if (window.confirm('Weet je zeker dat je dit bericht permanent wilt verwijderen?')) {
            try {
                await deleteDoc(doc(db, "messages", messageId));
                showNotification('Bericht verwijderd.', 'success');
                closeModal();
            } catch (error) {
                console.error("Fout bij verwijderen bericht:", error);
                showNotification('Kon bericht niet verwijderen.', 'error');
            }
        }
    }
    async function handleAddComment(e) {
        e.preventDefault();
        const form = e.target;
        const messageId = form.dataset.id;
        const input = document.getElementById('comment-input');
        const content = input.value.trim();
        if (content) {
            const newComment = {
                content,
                author: currentUserDisplayName,
                createdAt: new Date() // Wordt server-side een timestamp
            };
            try {
                const msgRef = doc(db, "messages", messageId);
                await updateDoc(msgRef, {
                    comments: arrayUnion(newComment)
                });
                input.value = '';
            } catch (error) {
                console.error("Fout bij toevoegen reactie:", error);
                showNotification('Kon reactie niet plaatsen.', 'error');
            }
        }
    }

    // --- DEADLINES MODULE ---
    function renderDeadlinesPage() {
        const container = document.getElementById('deadlines-page');
        container.innerHTML = `
            <div class="flex flex-col h-screen">
                <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10 shrink-0">
                    <div class="flex items-center">
                        <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                        <div><h1 class="text-2xl font-bold text-primary">Deadlines Beheren</h1><p class="text-sm text-gray-500">Overzicht van alle deadlines</p></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="btn-back-to-hub text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Hub</button>
                        <button id="btn-new-deadline" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-sm">+ Nieuwe Deadline</button>
                    </div>
                </header>
                <main class="flex-grow p-4 md:p-6 lg:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8 overflow-hidden">
                    <section class="flex flex-col bg-white p-4 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold mb-4 border-b pb-2 text-accent">Deadlines voor mij</h2>
                        <div id="deadlines-for-me" class="overflow-y-auto no-scrollbar space-y-3"></div>
                    </section>
                    <section class="flex flex-col bg-white p-4 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold mb-4 border-b pb-2 text-gray-600">Deadlines door mij aangemaakt</h2>
                        <div id="deadlines-by-me" class="overflow-y-auto no-scrollbar space-y-3"></div>
                    </section>
                </main>
            </div>`;
        renderAllDeadlines();
    }

    function renderAllDeadlines() {
        const forMeContainer = document.getElementById('deadlines-for-me');
        const byMeContainer = document.getElementById('deadlines-by-me');
        if (!forMeContainer || !byMeContainer) return;

        const sortedDeadlines = [...allDeadlines].sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));

        const deadlinesForMe = sortedDeadlines.filter(d => d.assignedTo === currentUserDisplayName);
        const deadlinesByMe = sortedDeadlines.filter(d => d.createdBy === currentUserDisplayName);

        forMeContainer.innerHTML = deadlinesForMe.length ? deadlinesForMe.map(d => createDeadlineCard(d, true)).join('') : `<p class="text-gray-500 p-4">Geen deadlines aan u toegewezen.</p>`;
        byMeContainer.innerHTML = deadlinesByMe.length ? deadlinesByMe.map(d => createDeadlineCard(d, false)).join('') : `<p class="text-gray-500 p-4">U heeft geen deadlines aangemaakt.</p>`;
    }

    function createDeadlineCard(deadline, isForMe) {
        const isCompleted = deadline.status === 'completed';
        const isOverdue = !isCompleted && new Date(deadline.dueDate) < new Date();
        const cardClass = isCompleted ? 'bg-green-50' : (isOverdue ? 'bg-red-50' : 'bg-white');
        const borderClass = isCompleted ? 'border-green-400' : (isOverdue ? 'border-red-400' : 'border-gray-300');
        const formattedDate = new Date(deadline.dueDate).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long', year: 'numeric' });

        return `
            <div class="${cardClass} border-l-4 ${borderClass} p-4 rounded-md shadow-sm">
                <p class="font-semibold text-gray-800">${sanitizeInput(deadline.title)}</p>
                <div class="text-sm text-gray-500 mt-2 flex justify-between items-center">
                    <span>
                        ${isForMe ? `Van: <strong>${sanitizeInput(deadline.createdBy)}</strong>` : `Voor: <strong>${sanitizeInput(deadline.assignedTo)}</strong>`}
                        <br>
                        Deadline: <strong>${formattedDate}</strong>
                    </span>
                    ${isForMe && !isCompleted ? `<button class="btn-complete-deadline bg-primary hover:bg-primary-dark text-white text-xs font-bold py-2 px-3 rounded-md" data-id="${deadline.id}">Afronden</button>` : ''}
                    ${isCompleted ? `<span class="text-green-700 font-bold">Afgerond</span>` : ''}
                </div>
            </div>`;
    }
    
    function renderNewDeadlineModal() {
        const colleagueOptions = COLLEAGUES
            .filter(c => c !== currentUserDisplayName)
            .map(c => `<option value="${c}">${c}</option>`)
            .join('');

        const modalHTML = `
            <form id="deadline-form" class="bg-white rounded-lg shadow-2xl w-full max-w-lg">
                <header class="p-4 border-b"><h2 class="text-xl font-semibold text-primary">Nieuwe Deadline Instellen</h2></header>
                <main class="p-6 space-y-4">
                    <div>
                        <label for="deadline-title" class="block text-sm font-medium">Omschrijving</label>
                        <input type="text" id="deadline-title" class="mt-1 block w-full rounded-md" required>
                    </div>
                    <div>
                        <label for="deadline-assignee" class="block text-sm font-medium">Wijs toe aan collega</label>
                        <select id="deadline-assignee" class="mt-1 block w-full rounded-md">${colleagueOptions}</select>
                    </div>
                    <div>
                        <label for="deadline-duedate" class="block text-sm font-medium">Einddatum</label>
                        <input type="date" id="deadline-duedate" class="mt-1 block w-full rounded-md" required>
                    </div>
                </main>
                <footer class="bg-gray-50 p-4 flex justify-end items-center gap-4">
                    <button type="button" class="btn-close-modal text-sm font-medium">Annuleren</button>
                    <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg">Opslaan</button>
                </footer>
            </form>`;
        openModal(modalHTML);
    }
    
    function getDeadlineStats() {
        const openDeadlines = allDeadlines.filter(d => d.assignedTo === currentUserDisplayName && d.status === 'open').length;
        return { open: openDeadlines };
    }

    async function handleSaveDeadline(e) {
        e.preventDefault();
        const title = document.getElementById('deadline-title').value.trim();
        const assignedTo = document.getElementById('deadline-assignee').value;
        const dueDate = document.getElementById('deadline-duedate').value;

        if (!title || !assignedTo || !dueDate) {
            showNotification('Vul alle velden in.', 'error');
            return;
        }

        const newDeadline = {
            title,
            createdBy: currentUserDisplayName,
            assignedTo,
            dueDate,
            status: 'open'
        };

        try {
            await addDoc(collection(db, "deadlines"), newDeadline);
            showNotification('Deadline aangemaakt!', 'success');
            closeModal();
        } catch (error) {
            console.error("Fout bij opslaan deadline:", error);
            showNotification('Kon deadline niet opslaan.', 'error');
        }
    }

    async function handleCompleteDeadline(deadlineId) {
        try {
            const deadlineRef = doc(db, "deadlines", deadlineId);
            await updateDoc(deadlineRef, { status: 'completed' });
            showNotification('Deadline afgerond.', 'success');
        } catch (error) {
            console.error("Fout bij bijwerken deadline:", error);
            showNotification('Kon deadline niet bijwerken.', 'error');
        }
    }
    
    // --- STANDAARD DOCUMENTEN MODULE ---
    function renderDocsPage() {
        const container = document.getElementById('docs-page');
        const canManage = currentUserDisplayName === 'Ine van Dort';
        container.innerHTML = `
            <div class="flex flex-col h-screen">
                <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10 shrink-0">
                    <div class="flex items-center">
                        <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                        <div><h1 class="text-2xl font-bold text-primary">Standaard Documenten</h1><p class="text-sm text-gray-500">Centrale bibliotheek voor formulieren en templates</p></div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button class="btn-back-to-hub text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Hub</button>
                        ${canManage ? `<button id="btn-new-doc" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-sm">+ Nieuw Document</button>`: ''}
                    </div>
                </header>
                <main class="flex-grow p-4 md:p-6 lg:p-8">
                    <div id="docs-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </main>
            </div>`;
        renderAllDocuments();
    }

    function renderAllDocuments() {
        const grid = document.getElementById('docs-grid');
        if (!grid) return;
        if (standardDocuments.length > 0) {
            grid.innerHTML = standardDocuments.map(createDocumentCard).join('');
        } else {
            grid.innerHTML = `<p class="text-gray-500 col-span-full text-center">Geen documenten gevonden. Voeg een nieuw document toe.</p>`;
        }
    }

    function createDocumentCard(doc) {
        const canDownload = !!doc.downloadURL;
        const buttonClass = canDownload ? 'bg-primary hover:bg-primary-dark text-white' : 'bg-gray-200 text-gray-500 cursor-not-allowed';
        const buttonText = canDownload ? 'Download' : 'Geen Bestand';

        return `
            <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col">
                <h3 class="text-lg font-bold text-primary mb-2">${sanitizeInput(doc.title)}</h3>
                <p class="text-gray-600 flex-grow mb-4">${sanitizeInput(doc.description)}</p>
                ${doc.fileName ? `<p class="text-xs text-gray-500 mb-4 truncate">Bestand: ${sanitizeInput(doc.fileName)}</p>` : ''}
                <a href="${doc.downloadURL || '#'}" ${canDownload ? 'target="_blank" rel="noopener noreferrer"' : ''} class="download-doc-link mt-auto w-full text-center font-bold py-2 px-4 rounded-lg ${buttonClass}" data-id="${doc.id}">
                    ${buttonText}
                </a>
            </div>`;
    }

    function renderNewDocumentModal() {
        const modalHTML = `
            <form id="doc-form" class="bg-white rounded-lg shadow-2xl w-full max-w-lg">
                <header class="p-4 border-b"><h2 class="text-xl font-semibold text-primary">Nieuw Document Toevoegen</h2></header>
                <main class="p-6 space-y-4">
                    <div>
                        <label for="doc-title" class="block text-sm font-medium">Titel van document</label>
                        <input type="text" id="doc-title" class="mt-1 block w-full rounded-md" required>
                    </div>
                    <div>
                        <label for="doc-description" class="block text-sm font-medium">Korte omschrijving</label>
                        <textarea id="doc-description" rows="3" class="mt-1 block w-full rounded-md" required></textarea>
                    </div>
                    <div>
                        <label for="doc-file" class="block text-sm font-medium">Bijlage</label>
                        <input type="file" id="doc-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                    </div>
                </main>
                <footer class="bg-gray-50 p-4 flex justify-end items-center gap-4">
                    <button type="button" class="btn-close-modal text-sm font-medium">Annuleren</button>
                    <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg">Toevoegen</button>
                </footer>
            </form>`;
        openModal(modalHTML);
    }
    
    async function handleSaveDocument(e) {
        e.preventDefault();
        const submitButton = e.target.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Bezig...';

        const title = document.getElementById('doc-title').value.trim();
        const description = document.getElementById('doc-description').value.trim();
        const file = document.getElementById('doc-file').files[0];

        if (!title || !description || !file) {
            showNotification('Vul alle velden in en selecteer een bestand.', 'error');
            submitButton.disabled = false;
            submitButton.textContent = 'Toevoegen';
            return;
        }

        try {
            const filePath = `documents/${Date.now()}_${file.name}`;
            const fileRef = storageRef(storage, filePath);
            const uploadResult = await uploadBytes(fileRef, file);
            const downloadURL = await getDownloadURL(uploadResult.ref);

            const newDoc = {
                title,
                description,
                fileName: file.name,
                filePath: filePath,
                downloadURL: downloadURL,
                createdAt: serverTimestamp()
            };
            await addDoc(collection(db, "documents"), newDoc);
            
            showNotification('Document succesvol toegevoegd.', 'success');
            closeModal();
        } catch (error) {
            console.error("Fout bij uploaden document:", error);
            showNotification('Kon document niet uploaden.', 'error');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Toevoegen';
        }
    }
    
    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        document.body.addEventListener('click', (e) => {
            if (e.target.id === 'btn-go-to-prikbord') showPage('prikbord-page');
            if (e.target.id === 'btn-go-to-derdengeld') {
                if (window.derdengeldApp) window.derdengeldApp.renderDashboard();
                showDerdengeldPage('derdengeld-dashboard-page');
            }
            if (e.target.id === 'btn-go-to-deadlines') showPage('deadlines-page');
            if (e.target.id === 'btn-go-to-docs') showPage('docs-page');
            if (e.target.id === 'btn-go-to-jurisprudentie') showPage('jurisprudentie-page');
            if (e.target.closest('.btn-back-to-hub')) showPage('hub-page');
            const briefingItem = e.target.closest('.briefing-item');
            if (briefingItem) document.getElementById(briefingItem.dataset.actionId)?.click();

            if (e.target.closest('.btn-close-modal')) closeModal();

            if (e.target.id === 'btn-new-message') renderNewMessageModal();
            const viewBtn = e.target.closest('.btn-view-message'); if (viewBtn) renderMessageDetailModal(viewBtn.dataset.id);
            const editBtn = e.target.closest('.btn-edit-message'); if (editBtn) renderNewMessageModal(editBtn.dataset.id);
            const deleteBtn = e.target.closest('.btn-delete-message'); if (deleteBtn) handleDeleteMessage(deleteBtn.dataset.id);

            if (e.target.id === 'btn-new-deadline') renderNewDeadlineModal();
            const completeDeadlineBtn = e.target.closest('.btn-complete-deadline'); if (completeDeadlineBtn) handleCompleteDeadline(completeDeadlineBtn.dataset.id);
            
            if (e.target.id === 'btn-new-doc') renderNewDocumentModal();
            
            if (e.target.id === 'btn-new-schadestaat') showPage('schadestaat-page');
            const schadestaatItem = e.target.closest('.schadestaat-widget-item');
            if (schadestaatItem) showPage('schadestaat-page', { id: schadestaatItem.dataset.id });

            if (e.target.id === 'btn-clear-storage') {
               if (window.confirm('Deze knop is voor de oude lokale opslag. De data staat nu online in een database. Deze knop heeft geen functie meer.')) {
                   // Functie verwijderd, was voorheen localStorage.removeItem
                   showNotification('Deze actie is niet meer van toepassing.', 'info');
               }
            }
        });

        document.body.addEventListener('submit', (e) => {
            if (e.target.id === 'message-form') handleSaveMessage(e);
            if (e.target.id === 'comment-form') handleAddComment(e);
            if (e.target.id === 'deadline-form') handleSaveDeadline(e);
            if (e.target.id === 'doc-form') handleSaveDocument(e);
        });

        document.body.addEventListener('input', (e) => {
            if (['filter-search', 'filter-priority', 'filter-user'].includes(e.target.id)) {
                renderMessages();
            }
            if (e.target.id === 'schadestaat-widget-search') {
                renderSchadestatenWidget(e.target.value);
            }
        });
        document.body.addEventListener('change', (e) => { if (e.target.id === 'msg-visibility') document.getElementById('recipient-container').classList.toggle('hidden', e.target.value === 'public'); });
    }
    
    function showNotification(message, type = 'info') {
        const el = document.getElementById('notification');
        el.textContent = message; el.className = 'hidden';
        el.classList.add(type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600'));
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 3000);
    }
    
    // --- DERDENGELD MODULE ---
    function initializeDerdengeldApp() {
        const container = document.getElementById('derdengeld-app-container');
        container.innerHTML = `
            <div id="derdengeld-dashboard-page">
                <div class="flex flex-col h-screen">
                    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
                        <div class="flex items-center">
                            <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                            <div><h1 class="text-2xl font-bold text-primary">Derdengeld Verantwoording</h1><p class="text-sm text-gray-500">Dashboard</p></div>
                        </div>
                        <div class="flex items-center gap-4">
                            <button class="derdengeld-btn-back-to-hub btn-back-to-hub text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Hub</button>
                            <button id="derdengeld-btn-go-to-reports" class="text-sm font-medium text-gray-600 hover:text-primary">Rapportage</button>
                            <span id="derdengeld-user-welcome" class="text-sm font-medium">Welkom...</span>
                            <button id="derdengeld-btn-go-to-new-form" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-sm"> + Nieuw Formulier </button>
                        </div>
                    </header>
                    <main id="derdengeld-dashboard-grid" class="flex-grow p-4 md:p-6 lg:p-8 grid grid-cols-1 md:grid-cols-2 gap-6 overflow-y-auto">
                        <section class="flex flex-col"><h2 class="text-lg font-semibold mb-4 pb-2 border-b-2 border-yellow-500">Mijn Goedkeuringen</h2><div id="derdengeld-my-approvals-container" class="space-y-4 overflow-y-auto"><p class="text-sm text-gray-500">Geen openstaande verzoeken.</p></div></section>
                        <section class="flex flex-col"><h2 class="text-lg font-semibold mb-4 pb-2 border-b-2 border-accent">Mijn Openstaande Taken</h2><div id="derdengeld-my-tasks-container" class="space-y-4 overflow-y-auto"><p class="text-sm text-gray-500">Taken worden geladen...</p></div></section>
                        <section class="flex flex-col"><h2 class="text-lg font-semibold mb-4 pb-2 border-b-2 border-gray-300">Wachtend op Anderen</h2><div id="derdengeld-other-tasks-container" class="space-y-4 overflow-y-auto"><p class="text-sm text-gray-500">Taken worden geladen...</p></div></section>
                        <section class="flex flex-col"><h2 class="text-lg font-semibold mb-4 pb-2 border-b-2 border-gray-300">Recente Activiteit</h2><div id="derdengeld-activity-feed-container" class="space-y-3 overflow-y-auto"><p class="text-sm text-gray-500">Nog geen activiteit.</p></div></section>
                    </main>
                </div>
            </div>
            <div id="derdengeld-new-form-page" class="hidden">
               <div class="flex flex-col min-h-screen">
                    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
                        <div class="flex items-center">
                           <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                            <div><h1 class="text-2xl font-bold text-primary">Nieuwe Ontvangstbevestiging</h1><p class="text-sm text-gray-500">Vul de basisgegevens van de ontvangst in.</p></div>
                        </div>
                        <a href="#" class="derdengeld-btn-back-to-dashboard text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Dashboard</a>
                    </header>
                    <main class="flex-grow p-4 md:p-6 lg:p-8 flex justify-center items-start">
                        <form id="derdengeld-new-form-element" class="w-full max-w-4xl bg-white rounded-lg shadow-xl overflow-hidden">
                            <section class="p-6 border-b"><h2 class="text-xl font-semibold mb-4 text-primary">Ontvangstgegevens</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="derdengeld-transactiedatum" class="block text-sm font-medium text-gray-700">Datum</label><input type="date" id="derdengeld-transactiedatum" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" required></div><div><label for="derdengeld-afkomstig-van" class="block text-sm font-medium text-gray-700">Afkomstig van</label><input type="text" id="derdengeld-afkomstig-van" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Naam betaler" required></div><div class="md:col-span-2"><label for="derdengeld-inzake" class="block text-sm font-medium text-gray-700">Inzake</label><input type="text" id="derdengeld-inzake" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Dossier / CliÃ«nt" required></div><div><label for="derdengeld-derdenrekening" class="block text-sm font-medium text-gray-700">Derdenrekening (22.70.85.248)</label><div class="mt-1 relative"><div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center"><span class="text-gray-500 sm:text-sm">â‚¬</span></div><input type="number" id="derdengeld-derdenrekening" class="derdengeld-rekening-input block w-full rounded-md border-gray-300 pl-7 pr-12 sm:text-lg" step="0.01"></div></div><div><label for="derdengeld-kantoorrekening" class="block text-sm font-medium text-gray-700">Kantoorrekening (22.70.85.221)</label><div class="mt-1 relative"><div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center"><span class="text-gray-500 sm:text-sm">â‚¬</span></div><input type="number" id="derdengeld-kantoorrekening" class="derdengeld-rekening-input block w-full rounded-md border-gray-300 pl-7 pr-12 sm:text-lg" step="0.01"></div></div></div></section>
                            <section class="p-6"><h2 class="text-xl font-semibold mb-4 text-primary">Taken Toewijzen</h2><div id="derdengeld-taken-lijst" class="space-y-4"><p id="derdengeld-taken-placeholder" class="text-sm text-gray-500 text-center">Nog geen taken toegewezen.</p></div><button type="button" id="derdengeld-btn-open-modal" class="mt-6 w-full flex justify-center items-center px-4 py-2 border border-dashed border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">+ Taak Toewijzen</button></section>
                            <footer class="bg-gray-50 p-4 flex justify-end items-center gap-4"><button type="button" class="derdengeld-btn-back-to-dashboard text-sm font-medium text-gray-600 hover:text-gray-900">Annuleren</button><button type="button" id="derdengeld-btn-save-form" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg shadow-sm">Opslaan en Versturen</button></footer>
                        </form>
                    </main>
                </div>
            </div>
            <div id="derdengeld-task-view-page" class="hidden">
                <div class="flex flex-col min-h-screen">
                    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
                        <div class="flex items-center">
                            <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                            <div><h1 id="derdengeld-task-view-title" class="text-2xl font-bold text-primary">Verantwoording Laden...</h1><p id="derdengeld-task-view-subtitle" class="text-sm text-gray-500">Aangemaakt door: ...</p></div>
                        </div>
                        <a href="#" class="derdengeld-btn-back-to-dashboard text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Dashboard</a>
                    </header>
                    <main class="flex-grow p-4 md:p-6 lg:p-8 flex justify-center items-start"><div class="w-full max-w-4xl bg-white rounded-lg shadow-xl overflow-hidden"><section id="derdengeld-task-view-header" class="p-6 bg-accent text-white"></section><section id="derdengeld-task-interaction-section" class="p-6 border-b"></section><section class="p-6 border-b bg-gray-50"><h2 class="text-xl font-semibold mb-4 text-gray-600">Hoofdgegevens (informatief)</h2><div id="derdengeld-task-view-main-data" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></section><section class="p-6 bg-gray-50 border-b"><h2 class="text-xl font-semibold mb-4 text-gray-600">Communicatie & Geschiedenis</h2><div id="derdengeld-task-history-log" class="space-y-3 text-sm text-gray-600 max-h-64 overflow-y-auto"></div><div class="mt-4 flex gap-2"><input type="text" id="derdengeld-new-comment-input" class="flex-grow rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Plaats een opmerking..."><button id="derdengeld-btn-add-comment" class="bg-primary text-white px-4 py-2 rounded-md font-medium">Plaats</button></div></section><footer id="derdengeld-task-view-footer" class="bg-gray-50 p-4 flex justify-end items-center gap-4"></footer></div></main>
                </div>
            </div>
            <div id="derdengeld-report-page" class="hidden">
                <div class="flex flex-col h-screen">
                    <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
                        <div class="flex items-center">
                            <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                            <div><h1 class="text-2xl font-bold text-primary">Rapportage</h1><p class="text-sm text-gray-500">Overzicht van alle formulieren</p></div>
                        </div>
                        <a href="#" class="derdengeld-btn-back-to-dashboard text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Dashboard</a>
                    </header>
                    <main class="flex-grow p-4 md:p-6 lg:p-8 overflow-y-auto"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-gray-500">Totaal Formulieren</p><p id="derdengeld-stats-total-forms" class="text-2xl font-bold">0</p></div><div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-gray-500">Totaal Open Taken</p><p id="derdengeld-stats-open-tasks" class="text-2xl font-bold text-yellow-600">0</p></div><div class="bg-white p-4 rounded-lg shadow"><p class="text-sm text-gray-500">Volledig Afgerond</p><p id="derdengeld-stats-completed-forms" class="text-2xl font-bold text-green-600">0</p></div></div><div class="bg-white rounded-lg shadow overflow-hidden"><table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Inzake</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Totaalbedrag</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Open Taken</th></tr></thead><tbody id="derdengeld-report-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></main>
                </div>
            </div>
            <div id="derdengeld-add-task-modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg"><header class="p-4 border-b"><h2 class="text-xl font-semibold text-primary">Taak Toewijzen</h2></header><main class="p-6 space-y-4"><div><label for="derdengeld-modal-collega" class="block text-sm font-medium text-gray-700">Wijs toe aan collega:</label><select id="derdengeld-modal-collega" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></select></div><div><label for="derdengeld-modal-taak-type" class="block text-sm font-medium text-gray-700">Type taak:</label><select id="derdengeld-modal-taak-type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"><option value="verantwoording">Verantwoording Invullen</option><option value="doorbetaling">Doorbetaling Voorbereiden</option></select></div></main><footer class="bg-gray-50 p-4 flex justify-end items-center gap-4 rounded-b-lg"><button type="button" id="derdengeld-btn-close-modal" class="text-sm font-medium text-gray-600 hover:text-gray-900">Annuleren</button><button type="button" id="derdengeld-btn-add-task" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg shadow-sm">Taak Toewijzen</button></footer></div>
            </div>
        `;
    
        // Lokale staat voor de Derdengeld-module
        const derdengeld_localDatabase = {
            forms: [],
            takeoverRequests: [],
            reopenRequests: [],
            activityLog: []
        };
        
        let derdengeld_currentUserDisplayName = currentUserDisplayName;
        let derdengeld_takenBuffer = [];
        let derdengeld_activeTask = null;
        let derdengeld_lastUsedDate = new Date().toISOString().split('T')[0];
        
        function derdengeld_init() {
            const modalCollegaSelect = document.getElementById('derdengeld-modal-collega');
            modalCollegaSelect.innerHTML = COLLEAGUES.map(c => `<option>${c}</option>`).join('');
            document.getElementById('derdengeld-user-welcome').textContent = `Welkom, ${derdengeld_currentUserDisplayName}`;
            derdengeld_renderDashboard();
            derdengeld_setupEventListeners();
        }
        
        function derdengeld_renderDashboard() {
            const myTasksContainer = document.getElementById('derdengeld-my-tasks-container');
            const otherTasksContainer = document.getElementById('derdengeld-other-tasks-container');
            const activityContainer = document.getElementById('derdengeld-activity-feed-container');
            const approvalsContainer = document.getElementById('derdengeld-my-approvals-container');
    
            myTasksContainer.innerHTML = ''; otherTasksContainer.innerHTML = ''; activityContainer.innerHTML = ''; approvalsContainer.innerHTML = '';
    
            const allTasks = derdengeld_localDatabase.forms.flatMap(form => (form.taken || []).map(taak => ({ ...taak, formId: form.id, formInzake: form.inzake, aangemaaktDoor: form.aangemaaktDoor, totaalbedrag: form.bedrag })));
            const myOpenTasks = allTasks.filter(taak => taak.collega === derdengeld_currentUserDisplayName && taak.status === 'open');
            const otherOpenTasks = allTasks.filter(taak => taak.collega !== derdengeld_currentUserDisplayName && taak.status === 'open');
            
            myTasksContainer.innerHTML = myOpenTasks.length ? myOpenTasks.map(t => derdengeld_createTaskCard(t, true)).join('') : '<p class="text-sm text-gray-500">Je hebt geen openstaande taken.</p>';
            otherTasksContainer.innerHTML = otherOpenTasks.length ? otherOpenTasks.map(t => derdengeld_createTaskCard(t, false)).join('') : '<p class="text-sm text-gray-500">Er zijn geen andere openstaande taken.</p>';
    
            const takeoverRequests = derdengeld_localDatabase.takeoverRequests.filter(req => {
                const form = derdengeld_localDatabase.forms.find(f => f.id === req.formId);
                return form && form.aangemaaktDoor === derdengeld_currentUserDisplayName && req.status === 'pending';
            });
            takeoverRequests.forEach(req => {
                const form = derdengeld_localDatabase.forms.find(f => f.id === req.formId);
                if (form) approvalsContainer.innerHTML += derdengeld_createTakeoverApprovalCard(req, form.inzake);
            });
    
            if (derdengeld_currentUserDisplayName === 'Ine van Dort') {
                const reopenRequests = derdengeld_localDatabase.reopenRequests.filter(req => req.status === 'pending');
                reopenRequests.forEach(req => {
                    const form = derdengeld_localDatabase.forms.find(f => f.id === req.formId);
                    if (form) approvalsContainer.innerHTML += derdengeld_createReopenApprovalCard(req, form.inzake);
                });
            }
    
            if (approvalsContainer.innerHTML.trim() === '') approvalsContainer.innerHTML = '<p class="text-sm text-gray-500">Geen openstaande verzoeken.</p>';
            
            activityContainer.innerHTML = derdengeld_localDatabase.activityLog.length ? [...derdengeld_localDatabase.activityLog].reverse().slice(0, 10).map(derdengeld_createActivityItem).join('') : '<p class="text-sm text-gray-500">Nog geen activiteit.</p>';
            updateDashboard();
        }
        
        function derdengeld_createTakeoverApprovalCard(req, inzake) { return `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-yellow-500"><h3 class="font-bold text-gray-800">Inzake: ${inzake}</h3><p class="text-sm mt-2"><span class="font-semibold">${req.requestedBy}</span> wil taak overnemen van <span class="font-semibold">${req.originalOwner}</span>.</p><div class="flex justify-end gap-2 mt-3"><button data-request-id="${req.id}" class="derdengeld-btn-reject-takeover text-xs font-bold py-1 px-3 rounded-lg bg-red-100 text-red-700 hover:bg-red-200">Afwijzen</button><button data-request-id="${req.id}" class="derdengeld-btn-approve-takeover text-xs font-bold py-1 px-3 rounded-lg bg-green-100 text-green-700 hover:bg-green-200">Goedkeuren</button></div></div>`; }
        function derdengeld_createReopenApprovalCard(req, inzake) { return `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-500"><h3 class="font-bold text-gray-800">Inzake: ${inzake}</h3><p class="text-sm mt-2"><span class="font-semibold">${req.requestedBy}</span> verzoekt om taak te heropenen.</p><div class="flex justify-end gap-2 mt-3"><button data-request-id="${req.id}" class="derdengeld-btn-reject-reopen text-xs font-bold py-1 px-3 rounded-lg bg-red-100 text-red-700 hover:bg-red-200">Afwijzen</button><button data-request-id="${req.id}" class="derdengeld-btn-approve-reopen text-xs font-bold py-1 px-3 rounded-lg bg-green-100 text-green-700 hover:bg-green-200">Goedkeuren</button></div></div>`; }
        function derdengeld_createTaskCard(taak, isMine) { const borderColor = isMine ? 'border-accent' : 'border-gray-300'; const titleColor = isMine ? 'text-primary' : 'text-gray-700'; const taakNaam = taak.type === 'verantwoording' ? 'Verantwoording' : 'Doorbetaling'; return `<div class="bg-white p-4 rounded-lg shadow-md border-l-4 ${borderColor} cursor-pointer derdengeld-task-card" data-form-id="${taak.formId}" data-taak-id="${taak.id}"><h3 class="font-bold ${titleColor}">Inzake: ${taak.formInzake}</h3><p class="text-sm font-semibold mt-2">Taak: ${taakNaam} (â‚¬ ${taak.totaalbedrag.toFixed(2)})</p>${!isMine ? `<p class="text-sm mt-1">Wacht op: <span class="font-semibold">${taak.collega}</span></p>` : ''}</div>`; }
        function derdengeld_createActivityItem(log) { const timestamp = new Date(log.timestamp).toLocaleString('nl-NL', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }); const isClickable = log.message.includes('heeft de taak afgerond'); const cursorClass = isClickable ? 'cursor-pointer hover:bg-gray-200' : ''; const dataAttributes = isClickable ? `data-form-id="${log.formId}" data-taak-id="${log.taakId}"` : ''; const itemClass = isClickable ? 'derdengeld-completed-task-item' : ''; return `<div class="text-sm p-3 bg-gray-100 rounded-md ${cursorClass} ${itemClass}" ${dataAttributes}><p>${log.message}</p><p class="text-xs text-gray-500 mt-1">${timestamp}</p></div>`; }
        function derdengeld_renderTaken() { const container = document.getElementById('derdengeld-taken-lijst'); const placeholder = document.getElementById('derdengeld-taken-placeholder'); if (!container || !placeholder) return; container.querySelectorAll('.derdengeld-taak-item').forEach(el => el.remove()); if (derdengeld_takenBuffer.length === 0) { placeholder.classList.remove('hidden'); } else { placeholder.classList.add('hidden'); derdengeld_takenBuffer.forEach((taak, index) => { const taakElement = document.createElement('div'); taakElement.className = 'derdengeld-taak-item bg-subtle p-4 rounded-md border flex items-center justify-between'; const taakNaam = taak.type === 'verantwoording' ? 'Verantwoording' : 'Doorbetaling'; taakElement.innerHTML = `<div><p class="font-semibold">${taakNaam}</p><p class="text-sm text-gray-600">Toegewezen aan: <span class="font-medium">${taak.collega}</span></p></div><button type="button" data-index="${index}" class="derdengeld-btn-remove-task text-gray-400 hover:text-red-600 text-xl">&times;</button>`; container.appendChild(taakElement); }); } }
        function derdengeld_findTask(formId, taakId) { const form = derdengeld_localDatabase.forms.find(f => f.id === formId); const taak = form ? (form.taken || []).find(t => t.id === taakId) : undefined; return { form, taak }; }
        function derdengeld_renderReportPage() { const forms = derdengeld_localDatabase.forms; document.getElementById('derdengeld-stats-total-forms').textContent = forms.length; const allTasks = forms.flatMap(form => form.taken || []); const openTasks = allTasks.filter(t => t.status === 'open').length; document.getElementById('derdengeld-stats-open-tasks').textContent = openTasks; const completedForms = forms.filter(form => (form.taken || []).every(t => t.status === 'completed')).length; document.getElementById('derdengeld-stats-completed-forms').textContent = completedForms; const tableBody = document.getElementById('derdengeld-report-table-body'); tableBody.innerHTML = ''; if (forms.length === 0) { tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Geen data om te tonen.</td></tr>`; return; } forms.forEach(form => { const openTasksCount = (form.taken || []).filter(t => t.status === 'open').length; const status = openTasksCount === 0 ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Voltooid</span>' : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">In behandeling</span>`; const row = `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${form.inzake || 'Geen omschrijving'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">â‚¬ ${form.bedrag.toFixed(2)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${status}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${openTasksCount}</td></tr>`; tableBody.innerHTML += row; }); }
        
        function derdengeld_populateTaskView(form, taak) {
            derdengeld_activeTask = { formId: form.id, taakId: taak.id, originalAmount: form.bedrag };
            document.getElementById('derdengeld-task-view-title').textContent = `Inzake: ${form.inzake}`;
            document.getElementById('derdengeld-task-view-subtitle').textContent = `Aangemaakt door: ${form.aangemaaktDoor}`;
            const header = document.getElementById('derdengeld-task-view-header');
            const taakNaam = taak.type === 'verantwoording' ? 'Verantwoording' : 'Doorbetaling';
            header.innerHTML = `<h2 class="text-2xl font-bold">Taak: ${taakNaam}</h2><p class="mt-1">Totaalbedrag: <strong>â‚¬ ${form.bedrag.toFixed(2)}</strong>.</p>`;
            const mainData = document.getElementById('derdengeld-task-view-main-data');
            mainData.innerHTML = `<div><label class="block text-sm font-medium text-gray-700">Afkomstig van</label><input type="text" value="${form.afkomstigVan}" class="mt-1 block w-full rounded-md readonly-input" readonly></div><div><label class="block text-sm font-medium text-gray-700">Datum van transactie</label><input type="text" value="${form.datum}" class="mt-1 block w-full rounded-md readonly-input" readonly></div>`;
            const interactionSection = document.getElementById('derdengeld-task-interaction-section');
            interactionSection.innerHTML = `<div class="space-y-6"><div><h3 class="text-lg font-semibold mb-2">Verantwoording (Declaraties)</h3><div id="derdengeld-declaratie-regels" class="space-y-2"></div><div class="flex gap-4 mt-2"><button id="derdengeld-btn-add-declaratie" class="text-sm text-primary font-medium hover:underline">+ Declaratieregel</button><button id="derdengeld-btn-add-credit" class="text-sm text-primary font-medium hover:underline">+ Creditdeclaratieregel</button></div><div class="text-right font-bold mt-2">Subtotaal: â‚¬ <span id="derdengeld-verantwoording-subtotaal">0.00</span></div></div><hr><div><h3 class="text-lg font-semibold mb-2">Doorbetalingen</h3><div id="derdengeld-doorbetaling-regels" class="space-y-4"></div><button id="derdengeld-btn-add-doorbetaling" class="text-sm text-primary font-medium hover:underline mt-2">+ Doorbetaling</button><div class="text-right font-bold mt-2">Totaal: â‚¬ <span id="derdengeld-doorbetaling-totaal">0.00</span></div></div><hr><div class="text-right font-bold text-lg mt-2">Balans: <span id="derdengeld-balans-totaal" class="px-2 py-1 rounded">â‚¬ 0.00</span></div></div>`;
            const footer = document.getElementById('derdengeld-task-view-footer');
            const hasPendingTakeover = derdengeld_localDatabase.takeoverRequests.some(r => r.taakId === taak.id && r.status === 'pending');
            const hasPendingReopen = derdengeld_localDatabase.reopenRequests.some(r => r.taakId === taak.id && r.status === 'pending');
            if (taak.status === 'completed') {
                if (hasPendingReopen) {
                    footer.innerHTML = `<button disabled class="bg-gray-400 text-white font-bold py-2 px-5 rounded-lg shadow-sm cursor-not-allowed">Heropening Aangevraagd</button>`;
                } else {
                    footer.innerHTML = `<button id="derdengeld-btn-request-reopen" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-5 rounded-lg shadow-sm">Heropening Aanvragen</button>`;
                }
                interactionSection.classList.add('disabled-section');
            } else if (taak.collega === derdengeld_currentUserDisplayName) {
                footer.innerHTML = `<button id="derdengeld-btn-complete-task" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-5 rounded-lg shadow-sm">Taak Afronden</button>`;
                interactionSection.classList.remove('disabled-section');
            } else {
                if (hasPendingTakeover) {
                    footer.innerHTML = `<button disabled class="bg-gray-400 text-white font-bold py-2 px-5 rounded-lg shadow-sm cursor-not-allowed">Verzoek Ingediend</button>`;
                } else {
                    footer.innerHTML = `<button id="derdengeld-btn-request-takeover" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-5 rounded-lg shadow-sm">Overname Aanvragen</button>`;
                }
                interactionSection.classList.add('disabled-section');
            }
            const historyLog = document.getElementById('derdengeld-task-history-log');
            historyLog.innerHTML = '';
            if (form.history && form.history.length > 0) {
                [...form.history].reverse().forEach(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString('nl-NL', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    historyLog.innerHTML += `<div class="p-2 border-b border-gray-200"><div>${log.message}</div><div class="text-xs text-gray-500 text-right">${timestamp}</div></div>`;
                });
            } else {
                historyLog.innerHTML = '<p class="text-gray-500">Geen geschiedenis voor dit formulier.</p>';
            }
            derdengeld_renderExistingDetails(form);
        }
        
        function derdengeld_addDeclaratieRow(declaratie = null, isCredit = false) {
            const container = document.getElementById('derdengeld-declaratie-regels');
            const div = document.createElement('div');
            div.className = 'derdengeld-detail-row derdengeld-declaratie-row grid grid-cols-12 gap-x-2 items-start';
            div.dataset.isCredit = isCredit;
            const omschrijving = declaratie ? declaratie.omschrijving : '';
            const bedrag = declaratie ? Math.abs(declaratie.bedrag) : '';
            const fileName = declaratie ? declaratie.fileName : '';
            div.innerHTML = `<div class="col-span-5"><input type="text" class="derdengeld-omschrijving-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="${omschrijving}" placeholder="${isCredit ? 'Creditdeclaratienummer' : 'Declaratienummer'}"></div><div class="col-span-3 relative"><div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center"><span class="text-gray-500 sm:text-sm">${isCredit ? '- â‚¬' : 'â‚¬'}</span></div><input type="number" class="derdengeld-bedrag-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm pl-8" value="${bedrag}" step="0.01" placeholder="0.00"></div><div class="col-span-3"><button type="button" class="derdengeld-btn-upload-file mt-1 w-full text-sm text-gray-700 bg-gray-100 hover:bg-gray-200 py-2 px-3 rounded-md shadow-sm border border-gray-300">Bestand kiezen</button><input type="file" class="derdengeld-file-input hidden"><span class="derdengeld-file-name-display text-xs text-gray-500 mt-1 truncate block">${fileName || ''}</span></div><div class="col-span-1 text-right"><button type="button" class="derdengeld-btn-remove-row text-gray-400 hover:text-red-600 text-2xl mt-1">&times;</button></div>`;
            container.appendChild(div);
            derdengeld_updateTotals();
        }
        
        function derdengeld_addDoorbetalingRow(doorbetaling = null) {
            const container = document.getElementById('derdengeld-doorbetaling-regels');
            const div = document.createElement('div');
            div.className = 'derdengeld-detail-row derdengeld-doorbetaling-row bg-gray-50 p-4 rounded-lg border relative';
            const naam = doorbetaling ? doorbetaling.naam : '';
            const iban = doorbetaling ? doorbetaling.iban : '';
            const omschrijving = doorbetaling ? doorbetaling.omschrijving : '';
            const bic = doorbetaling ? doorbetaling.bic : '';
            const bedrag = doorbetaling ? doorbetaling.bedrag : '';
            const spoed = doorbetaling ? doorbetaling.spoed : false;
            const fileName = doorbetaling ? doorbetaling.fileName : '';
            div.innerHTML = `<button type="button" class="derdengeld-btn-remove-row absolute top-2 right-3 text-gray-400 hover:text-red-600 text-2xl">&times;</button><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-gray-600">Naam</label><input type="text" class="derdengeld-naam-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="${naam}"></div><div><label class="block text-xs font-medium text-gray-600">IBAN</label><input type="text" class="derdengeld-iban-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="${iban}"></div><div class="md:col-span-2"><label class="block text-xs font-medium text-gray-600">Omschrijving</label><input type="text" class="derdengeld-omschrijving-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="${omschrijving}"></div><div><label class="block text-xs font-medium text-gray-600">BIC (optioneel)</label><input type="text" class="derdengeld-bic-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" value="${bic}"></div><div><label class="block text-xs font-medium text-gray-600">Bedrag</label><div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center"><span class="text-gray-500 sm:text-sm">â‚¬</span></div><input type="number" class="derdengeld-bedrag-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm pl-7" value="${bedrag}" step="0.01" placeholder="0.00"></div></div><div class="md:col-span-2"><label class="block text-xs font-medium text-gray-600">Bijlage</label><button type="button" class="derdengeld-btn-upload-file mt-1 w-full text-sm text-gray-700 bg-white hover:bg-gray-50 py-2 px-3 rounded-md shadow-sm border border-gray-300">Bestand kiezen</button><input type="file" class="derdengeld-file-input hidden"><span class="derdengeld-file-name-display text-xs text-gray-500 mt-1 truncate block">${fileName || ''}</span></div></div><div class="mt-4"><label class="flex items-center"><input type="checkbox" class="derdengeld-spoed-checkbox h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" ${spoed ? 'checked' : ''}><span class="ml-2 text-sm text-gray-700">Kosten voor spoedopdracht meenemen? (+ â‚¬6.00)</span></label></div>`;
            container.appendChild(div);
            derdengeld_updateTotals();
        }
        
        function derdengeld_renderExistingDetails(form) {
            if (form.declaraties) {
                form.declaraties.forEach(d => derdengeld_addDeclaratieRow(d, d.bedrag < 0));
            }
            if (form.doorbetalingen) {
                form.doorbetalingen.forEach(d => derdengeld_addDoorbetalingRow(d));
            }
            derdengeld_updateTotals();
        }
        
        function derdengeld_updateTotals() {
            let declaratieTotaal = 0;
            document.querySelectorAll('.derdengeld-declaratie-row').forEach(row => {
                const bedragInput = row.querySelector('.derdengeld-bedrag-input');
                let bedrag = parseFloat(bedragInput.value) || 0;
                if (row.dataset.isCredit === 'true') {
                    declaratieTotaal -= bedrag;
                } else {
                    declaratieTotaal += bedrag;
                }
            });
            document.getElementById('derdengeld-verantwoording-subtotaal').textContent = declaratieTotaal.toFixed(2);
            let doorbetalingTotaal = 0;
            document.querySelectorAll('.derdengeld-doorbetaling-row').forEach(row => {
                let bedrag = parseFloat(row.querySelector('.derdengeld-bedrag-input').value) || 0;
                if (row.querySelector('.derdengeld-spoed-checkbox').checked) {
                    bedrag += 6.00;
                }
                doorbetalingTotaal += bedrag;
            });
            document.getElementById('derdengeld-doorbetaling-totaal').textContent = doorbetalingTotaal.toFixed(2);
            if (!derdengeld_activeTask) return;
            const balans = derdengeld_activeTask.originalAmount - declaratieTotaal - doorbetalingTotaal;
            const balansEl = document.getElementById('derdengeld-balans-totaal');
            balansEl.textContent = `â‚¬ ${balans.toFixed(2)}`;
            if (Math.abs(balans) < 0.01) {
                balansEl.className = 'px-2 py-1 rounded bg-green-100 text-green-800';
            } else {
                balansEl.className = 'px-2 py-1 rounded bg-red-100 text-red-800';
            }
        }
        
        function derdengeld_saveTaskDetails(form) {
            form.declaraties = [];
            document.querySelectorAll('.derdengeld-declaratie-row').forEach(row => {
                const omschrijving = row.querySelector('.derdengeld-omschrijving-input').value.trim();
                let bedrag = parseFloat(row.querySelector('.derdengeld-bedrag-input').value) || 0;
                if (row.dataset.isCredit === 'true') {
                    bedrag = -bedrag;
                }
                if (omschrijving && bedrag !== 0) {
                    form.declaraties.push({
                        omschrijving,
                        bedrag,
                        fileName: row.querySelector('.derdengeld-file-name-display').textContent || null
                    });
                }
            });
            form.doorbetalingen = [];
            document.querySelectorAll('.derdengeld-doorbetaling-row').forEach(row => {
                const bedrag = parseFloat(row.querySelector('.derdengeld-bedrag-input').value) || 0;
                const naam = row.querySelector('.derdengeld-naam-input').value.trim();
                if (naam && bedrag > 0) {
                    form.doorbetalingen.push({
                        naam: naam,
                        iban: row.querySelector('.derdengeld-iban-input').value.trim(),
                        omschrijving: row.querySelector('.derdengeld-omschrijving-input').value.trim(),
                        bic: row.querySelector('.derdengeld-bic-input').value.trim(),
                        bedrag: bedrag,
                        spoed: row.querySelector('.derdengeld-spoed-checkbox').checked,
                        fileName: row.querySelector('.derdengeld-file-name-display').textContent || null
                    });
                }
            });
            derdengeld_logEvent(form.id, derdengeld_activeTask.taakId, `<span class="font-semibold">${derdengeld_currentUserDisplayName}</span> heeft de details van de taak bijgewerkt.`);
        }
        
        function derdengeld_validateTaskDetails() {
            document.querySelectorAll('.invalid-input').forEach(el => el.classList.remove('invalid-input'));
            const declaratieRows = document.querySelectorAll('.derdengeld-declaratie-row');
            const doorbetalingRows = document.querySelectorAll('.derdengeld-doorbetaling-row');
            if (declaratieRows.length === 0 && doorbetalingRows.length === 0) {
                showNotification('Voeg minimaal Ã©Ã©n declaratie- of doorbetalingsregel toe.', 'error');
                return false;
            }
            let isValid = true;
            declaratieRows.forEach((row) => {
                const omschrijvingInput = row.querySelector('.derdengeld-omschrijving-input');
                const bedragInput = row.querySelector('.derdengeld-bedrag-input');
                if (!omschrijvingInput.value.trim()) {
                    omschrijvingInput.classList.add('invalid-input');
                    isValid = false;
                }
                if (!bedragInput.value || parseFloat(bedragInput.value) <= 0) {
                    bedragInput.classList.add('invalid-input');
                    isValid = false;
                }
            });
            doorbetalingRows.forEach((row) => {
                const naamInput = row.querySelector('.derdengeld-naam-input');
                const ibanInput = row.querySelector('.derdengeld-iban-input');
                const omschrijvingInput = row.querySelector('.derdengeld-omschrijving-input');
                const bedragInput = row.querySelector('.derdengeld-bedrag-input');
                if (!naamInput.value.trim()) {
                    naamInput.classList.add('invalid-input');
                    isValid = false;
                }
                if (!ibanInput.value.trim()) {
                    ibanInput.classList.add('invalid-input');
                    isValid = false;
                }
                if (!omschrijvingInput.value.trim()) {
                    omschrijvingInput.classList.add('invalid-input');
                    isValid = false;
                }
                if (!bedragInput.value || parseFloat(bedragInput.value) <= 0) {
                    bedragInput.classList.add('invalid-input');
                    isValid = false;
                }
            });
            if (!isValid) {
                showNotification('Vul alle verplichte velden in (gemarkeerd in rood).', 'error');
            }
            return isValid;
        }
        
        function derdengeld_saveNewForm() {
            const form = {
                id: `form_${Date.now()}`,
                datum: document.getElementById('derdengeld-transactiedatum').value,
                afkomstigVan: document.getElementById('derdengeld-afkomstig-van').value,
                inzake: document.getElementById('derdengeld-inzake').value,
                rekeningType: document.getElementById('derdengeld-derdenrekening').value ? 'derden' : 'kantoor',
                bedrag: parseFloat(document.getElementById('derdengeld-derdenrekening').value || document.getElementById('derdengeld-kantoorrekening').value) || 0,
                aangemaaktDoor: derdengeld_currentUserDisplayName,
                taken: derdengeld_takenBuffer,
                history: [],
                declaraties: [],
                doorbetalingen: []
            };
            if (!form.datum || !form.afkomstigVan || !form.inzake || !form.bedrag || form.taken.length === 0) {
                showNotification('Vul alle verplichte velden in en wijs minimaal Ã©Ã©n taak toe.', 'error');
                return;
            }
            derdengeld_lastUsedDate = form.datum;
            derdengeld_localDatabase.forms.push(form);
            derdengeld_logEvent(form.id, null, `<span class="font-semibold">${derdengeld_currentUserDisplayName}</span> heeft een nieuwe ontvangstbevestiging aangemaakt.`);
            showNotification('Formulier succesvol aangemaakt!', 'success');
            derdengeld_resetAndShowPage('derdengeld-dashboard-page');
        }
        
        function derdengeld_addTask() {
            const collega = document.getElementById('derdengeld-modal-collega').value;
            const type = document.getElementById('derdengeld-modal-taak-type').value;
            if (!collega || !type) {
                showNotification('Selecteer een collega en een type taak.', 'error');
                return;
            }
            derdengeld_takenBuffer.push({
                id: `taak_${Date.now()}_${Math.random()}`,
                collega,
                type,
                status: 'open'
            });
            derdengeld_renderTaken();
            document.getElementById('derdengeld-add-task-modal').classList.add('hidden');
        }
        
        function derdengeld_resetNewForm() {
            const form = document.getElementById('derdengeld-new-form-element');
            if (form) form.reset();
            derdengeld_takenBuffer = [];
            derdengeld_renderTaken();
        }
        
        function derdengeld_logEvent(formId, taakId, message, type = 'generic') {
            // Dit is een lokale functie voor de Derdengeld module
        }
        
        function derdengeld_resetAndShowPage(pageId) {
            derdengeld_resetNewForm();
            showDerdengeldPage(pageId);
        }
        
        function derdengeld_setupEventListeners() {
            document.body.addEventListener('click', function(e) {
                if (e.target.id === 'derdengeld-btn-go-to-new-form') {
                    const dateInput = document.getElementById('derdengeld-transactiedatum');
                    if(dateInput) dateInput.value = derdengeld_lastUsedDate;
                    showDerdengeldPage('derdengeld-new-form-page');
                }
                if (e.target.id === 'derdengeld-btn-go-to-reports') {
                    derdengeld_renderReportPage();
                    showDerdengeldPage('derdengeld-report-page');
                }
                if (e.target.closest('.derdengeld-btn-back-to-dashboard')) {
                    e.preventDefault();
                    derdengeld_resetAndShowPage('derdengeld-dashboard-page');
                }
                if (e.target.id === 'derdengeld-btn-save-form') derdengeld_saveNewForm();
                if (e.target.id === 'derdengeld-btn-open-modal') document.getElementById('derdengeld-add-task-modal').classList.remove('hidden');
                if (e.target.id === 'derdengeld-btn-close-modal') document.getElementById('derdengeld-add-task-modal').classList.add('hidden');
                if (e.target.id === 'derdengeld-btn-add-task') derdengeld_addTask();
                const taskCard = e.target.closest('.derdengeld-task-card, .derdengeld-completed-task-item');
                if (taskCard) {
                    const { form, taak } = derdengeld_findTask(taskCard.dataset.formId, taskCard.dataset.taakId);
                    if (form && taak) {
                        derdengeld_populateTaskView(form, taak);
                        showDerdengeldPage('derdengeld-task-view-page');
                    }
                }
                if (e.target.id === 'derdengeld-btn-add-comment') { /* ... */ }
                if (e.target.id === 'derdengeld-btn-complete-task') { /* ... */ }
                if (e.target.id === 'derdengeld-btn-request-takeover') { /* ... */ }
                const approveBtn = e.target.closest('.derdengeld-btn-approve-takeover');
                if (approveBtn) { /* ... */ }
                const rejectBtn = e.target.closest('.derdengeld-btn-reject-takeover');
                if (rejectBtn) { /* ... */ }
                if (e.target.id === 'derdengeld-btn-request-reopen') { /* ... */ }
                const approveReopenBtn = e.target.closest('.derdengeld-btn-approve-reopen');
                if (approveReopenBtn) { /* ... */ }
                const rejectReopenBtn = e.target.closest('.derdengeld-btn-reject-reopen');
                if (rejectReopenBtn) { /* ... */ }
                const removeBtn = e.target.closest('.derdengeld-btn-remove-task');
                if (removeBtn) {
                    derdengeld_takenBuffer.splice(removeBtn.dataset.index, 1);
                    derdengeld_renderTaken();
                }
                if (e.target.id === 'derdengeld-btn-add-declaratie') derdengeld_addDeclaratieRow(null, false);
                if (e.target.id === 'derdengeld-btn-add-credit') derdengeld_addDeclaratieRow(null, true);
                if (e.target.id === 'derdengeld-btn-add-doorbetaling') derdengeld_addDoorbetalingRow();
                if (e.target.closest('.derdengeld-btn-remove-row')) {
                    e.target.closest('.derdengeld-detail-row').remove();
                    derdengeld_updateTotals();
                }
                const uploadBtn = e.target.closest('.derdengeld-btn-upload-file');
                if (uploadBtn) {
                    uploadBtn.nextElementSibling.click();
                }
            });
        }
    
        window.derdengeldApp = {
            setCurrentUser: (name) => {
                derdengeld_currentUserDisplayName = name;
                document.getElementById('derdengeld-user-welcome').textContent = `Welkom, ${name}`;
                derdengeld_renderDashboard();
            },
            getStats: () => {
                const allTasks = derdengeld_localDatabase.forms.flatMap(form => form.taken || []);
                const myOpenTasks = allTasks.filter(taak => taak.collega === currentUserDisplayName && taak.status === 'open').length;
                const myApprovals = derdengeld_localDatabase.takeoverRequests.filter(req => {
                    const form = derdengeld_localDatabase.forms.find(f => f.id === req.formId);
                    return form && form.aangemaaktDoor === currentUserDisplayName && req.status === 'pending';
                }).length + derdengeld_localDatabase.reopenRequests.filter(req => currentUserDisplayName === 'Ine van Dort' && req.status === 'pending').length;
                return { approvals: myApprovals, myTasks: myOpenTasks };
            },
            renderDashboard: derdengeld_renderDashboard
        };
    
        derdengeld_init();
    }

    // --- SCHADESTAAT MODULE ---
    function initializeSchadestaatApp() {
        const container = document.getElementById('schadestaat-page');
        container.innerHTML = `
            <div class="flex flex-col min-h-screen">
                <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10">
                        <div class="flex items-center">
                            <img src="https://i.postimg.cc/B690tTpb/temp-Image8-Bf-XYq.avif" alt="Van Dort Letselschade Logo" class="h-12 mr-4">
                            <div>
                                <h1 id="schadestaat-title" class="text-2xl font-bold text-primary">Digitale Schadestaat</h1>
                                <p class="text-sm text-gray-500">Dossierbeheer</p>
                            </div>
                        </div>
                        <button class="btn-back-to-hub text-sm font-medium text-gray-600 hover:text-primary">&larr; Terug naar Hub</button>
                   </header>
                   <div class="flex flex-col lg:flex-row">
                        <main class="w-full lg:w-2/3 p-4 sm:p-6 lg:p-8">
                            <section id="schade-validation-dashboard" class="validation-panel p-4 rounded-lg shadow-md mb-6 hidden">
                                <h3 class="text-lg font-semibold mb-3 text-red-800">âš ï¸ Validatie Waarschuwingen</h3>
                                <div id="schade-validation-items" class="space-y-2"></div>
                            </section>
                            <section class="bg-white p-6 rounded-lg shadow-md">
                                <div class="flex justify-between items-center mb-4 border-b pb-2">
                                    <h2 class="text-xl font-semibold text-primary">Schadeposten</h2>
                                    <button id="schade-add-schadepost" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary hover:bg-primary-dark">Nieuwe Hoofdpost</button>
                                </div>
                                <div id="schade-schadeposten-lijst" class="space-y-6"></div>
                            </section>
                        </main>
                        <aside class="w-full lg:w-1/3 bg-gray-50 p-4 sm:p-6 lg:p-8 border-l border-gray-200">
                            <div class="sticky top-8 space-y-6">
                                <section id="schade-dossier-info" class="bg-white p-6 rounded-lg shadow-md">
                                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-primary">Algemene Gegevens</h2>
                                    <div class="space-y-4">
                                        <div><label for="schade-dossiernummer" class="block text-sm font-medium text-gray-700">Dossiernummer Van Dort</label><input type="text" id="schade-dossiernummer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                        <div><label for="schade-contactpersoon" class="block text-sm font-medium text-gray-700">Contactpersoon intern</label><input type="text" id="schade-contactpersoon" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                        <div><label for="schade-benadeelde" class="block text-sm font-medium text-gray-700">CliÃ«nt (benadeelde)</label><input type="text" id="schade-benadeelde" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                        <div><label for="schade-geboortedatum" class="block text-sm font-medium text-gray-700">Geboortedatum</label><input type="date" id="schade-geboortedatum" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                        <div><label for="schade-schadedatum" class="block text-sm font-medium text-gray-700">Schadedatum</label><input type="date" id="schade-schadedatum" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                    </div>
                                </section>
                                <section id="schade-wederpartij-info" class="bg-white p-6 rounded-lg shadow-md">
                                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-primary">Gegevens Wederpartij</h2>
                                    <div class="space-y-4">
                                        <div><label for="schade-wederpartij-verzekeraar" class="block text-sm font-medium text-gray-700">Verzekeraar</label><input type="text" id="schade-wederpartij-verzekeraar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                        <div><label for="schade-wederpartij-contactpersoon" class="block text-sm font-medium text-gray-700">Contactpersoon</label><input type="text" id="schade-wederpartij-contactpersoon" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                        <div><label for="schade-wederpartij-schadenummer" class="block text-sm font-medium text-gray-700">Schadenummer</label><input type="text" id="schade-wederpartij-schadenummer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm"></div>
                                    </div>
                                </section>
                                <section class="bg-white p-6 rounded-lg shadow-md">
                                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-primary">Rente Instellingen</h2>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center">
                                            <label for="schade-rente-percentage" class="font-medium text-sm">Wettelijke rente %:</label>
                                            <div class="relative w-24">
                                                <input type="number" id="schade-rente-percentage" value="7.00" min="0" max="20" step="0.25" class="block w-full rounded-md border-gray-300 shadow-sm text-right pr-7 sm:text-sm">
                                                <div class="pointer-events-none absolute inset-y-0 right-0 pr-2 flex items-center"><span class="text-sm">%</span></div>
                                            </div>
                                        </div>
                                        <button id="schade-herbereken-rente" class="w-full bg-accent text-white px-4 py-2 rounded-md font-medium hover:bg-opacity-90">Herbereken Automatische Rente</button>
                                    </div>
                                </section>
                                <section class="bg-white p-6 rounded-lg shadow-md">
                                    <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-primary">Totaaloverzicht</h2>
                                    <div class="space-y-3 text-sm">
                                        <div class="flex justify-between items-center"><span class="font-medium">Totaal schadeposten:</span><span id="schade-totaal-schade" class="font-semibold text-base">â‚¬ 0,00</span></div>
                                        <div class="flex justify-between items-center"><label for="schade-wettelijke-rente" class="font-medium">Wettelijke Rente (auto):</label><div class="relative w-32"><div class="pointer-events-none absolute inset-y-0 left-0 pl-2 flex items-center"><span class="text-gray-500">â‚¬</span></div><input type="number" id="schade-wettelijke-rente" value="0" min="0" step="0.01" class="block w-full rounded-md border-gray-300 pl-7 text-right shadow-sm sm:text-sm readonly-input" readonly placeholder="0.00"></div></div>
                                        <div class="flex justify-between items-center"><label for="schade-bgk" class="font-medium">Buitengerechtelijke Kosten (BGK):</label><div class="relative w-32"><div class="pointer-events-none absolute inset-y-0 left-0 pl-2 flex items-center"><span class="text-gray-500">â‚¬</span></div><input type="number" id="schade-bgk" value="0" min="0" step="0.01" class="block w-full rounded-md border-gray-300 pl-7 text-right shadow-sm sm:text-sm" placeholder="0.00"></div></div>
                                        <div class="flex justify-between items-center border-t pt-2"><span class="font-medium">Vordering (excl. aanspr.):</span><span id="schade-vordering-bruto" class="font-semibold text-base">â‚¬ 0,00</span></div>
                                        <div class="flex justify-between items-center"><label for="schade-aansprakelijkheid" class="font-medium">Aansprakelijkheid:</label><div class="relative w-24"><input type="number" id="schade-aansprakelijkheid" value="100" min="0" max="100" class="block w-full rounded-md border-gray-300 shadow-sm text-right pr-7 sm:text-sm"><div class="pointer-events-none absolute inset-y-0 right-0 pr-2 flex items-center"><span>%</span></div></div></div>
                                        <div class="flex justify-between items-center border-t pt-2"><span class="font-medium">Vordering (incl. aanspr.):</span><span id="schade-vordering-netto" class="font-semibold text-base">â‚¬ 0,00</span></div>
                                        <div class="flex justify-between items-center"><label for="schade-verrichte-betalingen" class="font-medium">Reeds betaald:</label><div class="relative w-32"><div class="pointer-events-none absolute inset-y-0 left-0 pl-2 flex items-center"><span class="text-gray-500">â‚¬</span></div><input type="number" id="schade-verrichte-betalingen" value="0" min="0" step="0.01" class="block w-full rounded-md border-gray-300 pl-7 text-right shadow-sm sm:text-sm" placeholder="0.00"></div></div>
                                        <div class="flex justify-between items-center bg-subtle p-3 rounded-lg border-t-4 border-primary mt-2"><span class="font-bold text-lg">Openstaand Saldo:</span><span id="schade-saldo" class="font-bold text-2xl text-primary">â‚¬ 0,00</span></div>
                                    </div>
                                    <footer class="mt-6 pt-6 border-t">
                                        <div class="flex flex-wrap justify-center gap-3">
                                            <button id="schade-save-data" class="bg-primary text-white px-4 py-2 rounded-md font-semibold hover:bg-primary-dark shadow-sm">Opslaan in Hub</button>
                                            <button id="schade-export-excel" class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 shadow-sm">Excel Export</button>
                                            <button id="schade-print-export" class="bg-gray-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-gray-700 shadow-sm">Printen</button>
                                        </div>
                                        <p class="mt-4 text-center text-xs text-gray-500">Schadestaat onder voorbehoud van alle rechten en weren.</p>
                                    </footer>
                                </section>
                            </div>
                        </aside>
                   </div>
                   <div id="schade-print-output" class="print-only p-8"></div>
                </div>
            `;

        const schadepostenLijst = document.getElementById('schade-schadeposten-lijst');
        let validationTimer = null;
        new Sortable(schadepostenLijst, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost' });
        
        const getEl = (id) => document.getElementById(`schade-${id}`);
        const defaultSchadeposten = ["Voorschot smartengeld", "Zaakbeschadiging/zaakschade", "Medische kosten", "Reiskosten", "Huishoudelijke hulp", "Verlies aan verdienvermogen", "Daggeldvergoeding/verzorging", "Porto- en telefoonkosten", "Zelfwerkzaamheid", "Studie", "Overige kosten"];
        
        getEl('add-schadepost').addEventListener('click', () => createSchadepost(prompt("Naam van de nieuwe hoofdpost:", "")));
        
        ['bgk', 'aansprakelijkheid', 'verrichte-betalingen', 'geboortedatum', 'schadedatum', 'rente-percentage'].forEach(id => {
            const element = getEl(id);
            if (element) {
                element.addEventListener('input', () => {
                    if (id === 'rente-percentage') berekenAutomatischeRente();
                    berekenTotalen();
                    scheduleValidation();
                });
            }
        });

        getEl('herbereken-rente').addEventListener('click', berekenAutomatischeRente);

        function createSchadepost(titel, subRegelsData = []) {
            if (!titel) return;
            const postContainer = document.createElement('div');
            postContainer.className = 'schadepost-hoofd p-4 bg-white rounded-md shadow';
            postContainer.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <div class="flex items-center gap-3 flex-grow"><span class="drag-handle text-gray-400 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="19" r="1"></circle><circle cx="5" cy="5" r="1"></circle><circle cx="5" cy="12" r="1"></circle><circle cx="5" cy="19" r="1"></circle><circle cx="19" cy="5" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="19" cy="19" r="1"></circle></svg></span><input type="text" value="${titel}" class="omschrijving-hoofd text-lg font-semibold border-none p-0 focus:ring-0 flex-grow"></div>
                    <div class="flex items-center gap-4 flex-shrink-0"><span class="subtotaal-display font-bold text-primary">â‚¬ 0,00</span><button class="add-sub-regel-btn text-sm bg-accent text-white px-3 py-1 rounded-md hover:bg-opacity-90">Regel +</button><button class="remove-hoofdpost-btn text-gray-400 hover:text-red-600 text-xl">&times;</button></div>
                </div>
                <div class="sub-regels-container space-y-3"></div>`;
            schadepostenLijst.appendChild(postContainer);

            const subRegelsContainer = postContainer.querySelector('.sub-regels-container');
            if (subRegelsData.length > 0) subRegelsData.forEach(data => createSubRegel(subRegelsContainer, data));
            postContainer.querySelector('.add-sub-regel-btn').addEventListener('click', () => createSubRegel(subRegelsContainer));
            postContainer.querySelector('.remove-hoofdpost-btn').addEventListener('click', () => {
                if (confirm(`Weet u zeker dat u de hoofdpost "${titel}" en alle bijbehorende regels wilt verwijderen?`)) {
                    postContainer.remove();
                    berekenTotalen();
                    scheduleValidation();
                }
            });
            berekenTotalen();
        }

        function createSubRegel(container, data = {}) {
            const subRegelDiv = document.createElement('div');
            subRegelDiv.className = 'sub-regel p-3 rounded-md';
            subRegelDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-2">
                    <div class="md:col-span-3"><label class="text-xs font-medium text-gray-600 block">Datum</label><input type="date" class="datum w-full mt-1 sm:text-sm rounded-md border-gray-300 shadow-sm" value="${data.datum || ''}"></div>
                    <div class="md:col-span-5"><label class="text-xs font-medium text-gray-600 block">Bewijsstuk(ken)</label><input type="text" class="bewijsstuk w-full mt-1 sm:text-sm rounded-md border-gray-300 shadow-sm" placeholder="bv. Factuur Fysio" value="${data.bewijsstuk || ''}"></div>
                    <div class="md:col-span-4 flex items-end gap-2">
                        <div class="flex-grow"><label class="text-xs font-medium text-gray-600 block">Totaal incl.</label><input type="number" class="bedrag-totaal w-full mt-1 sm:text-sm rounded-md border-gray-300 shadow-sm text-right" step="0.01" placeholder="0.00" value="${data.totaal || ''}"></div>
                        <button class="bereken-btw-btn p-1 bg-gray-200 rounded-md hover:bg-gray-300" title="Bereken Netto en BTW (21%) vanuit dit totaalbedrag">â†µ</button>
                    </div>
                    <div class="md:col-span-10 grid grid-cols-1 md:grid-cols-10 gap-x-4">
                        <div class="md:col-span-5"><label class="text-xs font-medium text-gray-600 block">Toelichting</label><textarea class="toelichting w-full mt-1 sm:text-sm rounded-md border-gray-300 shadow-sm" rows="1">${data.toelichting || ''}</textarea></div>
                        <div class="md:col-span-3"><label class="text-xs font-medium text-gray-600 block">Netto (auto)</label><input type="number" class="bedrag-netto w-full mt-1 sm:text-sm rounded-md border-gray-300 shadow-sm text-right readonly-input" step="0.01" readonly value="${data.netto || ''}"></div>
                        <div class="md:col-span-2"><label class="text-xs font-medium text-gray-600 block">BTW (auto)</label><input type="number" class="bedrag-btw w-full mt-1 sm:text-sm rounded-md border-gray-300 shadow-sm text-right readonly-input" step="0.01" readonly value="${data.btw || ''}"></div>
                    </div>
                    <div class="md:col-span-2 flex flex-col justify-between items-end pt-1">
                        <div class="flex items-center space-x-2 mt-1"><label class="text-xs font-medium text-gray-600">Wett. Rente?</label><input type="checkbox" class="rente-check sm:text-sm rounded border-gray-300" ${data.rente ? 'checked' : ''}></div>
                        <button class="remove-sub-regel-btn text-gray-400 hover:text-red-500 text-xs mt-2">Verwijder</button>
                    </div>
                </div>`;
            container.appendChild(subRegelDiv);

            subRegelDiv.querySelector('.bereken-btw-btn').addEventListener('click', (e) => {
                const totaalInput = e.target.closest('.sub-regel').querySelector('.bedrag-totaal');
                const nettoInput = e.target.closest('.sub-regel').querySelector('.bedrag-netto');
                const btwInput = e.target.closest('.sub-regel').querySelector('.bedrag-btw');
                const totaal = parseFloat(totaalInput.value) || 0;
                if (totaal > 0) {
                    const netto = totaal / 1.21;
                    nettoInput.value = netto.toFixed(2);
                    btwInput.value = (totaal - netto).toFixed(2);
                    berekenTotalen();
                }
            });
            
            subRegelDiv.querySelectorAll('input, textarea').forEach(el => {
                const eventType = el.type === 'checkbox' ? 'change' : 'input';
                el.addEventListener(eventType, () => {
                    berekenTotalen();
                    berekenAutomatischeRente();
                    scheduleValidation();
                });
            });
            
            subRegelDiv.querySelector('.remove-sub-regel-btn').addEventListener('click', () => {
                subRegelDiv.remove();
                berekenTotalen();
                berekenAutomatischeRente();
                scheduleValidation();
            });
        }

        function berekenAutomatischeRente() {
            const rentePercentage = parseFloat(getEl('rente-percentage').value) || 7.00;
            let totaleRente = 0;
            const vandaag = new Date();
            document.querySelectorAll('#schade-schadeposten-lijst .rente-check:checked').forEach(checkbox => {
                const regel = checkbox.closest('.sub-regel');
                const bedrag = parseFloat(regel.querySelector('.bedrag-totaal').value) || 0;
                const datumString = regel.querySelector('.datum').value;
                if (bedrag > 0 && datumString) {
                    const startDatum = new Date(datumString);
                    if (startDatum < vandaag) {
                        const jaren = (vandaag - startDatum) / (1000 * 60 * 60 * 24 * 365.25);
                        totaleRente += bedrag * (rentePercentage / 100) * jaren;
                    }
                }
            });
            getEl('wettelijke-rente').value = totaleRente.toFixed(2);
        }
        
        function berekenTotalen() {
            let totaalSchade = 0;
            document.querySelectorAll('#schade-schadeposten-lijst .schadepost-hoofd').forEach(hoofdpost => {
                let subtotaal = 0;
                hoofdpost.querySelectorAll('.sub-regel .bedrag-totaal').forEach(input => subtotaal += parseFloat(input.value) || 0);
                hoofdpost.querySelector('.subtotaal-display').textContent = formatCurrency(subtotaal);
                totaalSchade += subtotaal;
            });

            getEl('totaal-schade').textContent = formatCurrency(totaalSchade);
            const wettelijkeRente = parseFloat(getEl('wettelijke-rente').value) || 0;
            const bgk = parseFloat(getEl('bgk').value) || 0;
            const vorderingBruto = totaalSchade + wettelijkeRente + bgk;
            getEl('vordering-bruto').textContent = formatCurrency(vorderingBruto);
            const aansprakelijkheid = parseFloat(getEl('aansprakelijkheid').value) || 100;
            const vorderingNetto = vorderingBruto * (aansprakelijkheid / 100);
            getEl('vordering-netto').textContent = formatCurrency(vorderingNetto);
            const verrichteBetalingen = parseFloat(getEl('verrichte-betalingen').value) || 0;
            const saldo = vorderingNetto - verrichteBetalingen;
            getEl('saldo').textContent = formatCurrency(saldo);
        }

        function scheduleValidation() {
            clearTimeout(validationTimer);
            validationTimer = setTimeout(validateForm, 500);
        }

        function validateForm() {
            const dashboard = getEl('validation-dashboard');
            if (new Date(getEl('schadedatum').value) < new Date(getEl('geboortedatum').value)) {
                getEl('validation-items').innerHTML = `<div class="validation-item p-2 rounded-md validation-error">Schadedatum ligt voor geboortedatum</div>`;
                dashboard.classList.remove('hidden');
            } else {
                dashboard.classList.add('hidden');
            }
        }

        function formatCurrency(value) { return `â‚¬ ${Number(value).toFixed(2).replace('.', ',')}`; }

        async function saveData() {
            const dossiernummer = getEl('dossiernummer').value.trim();
            if (!dossiernummer) {
                showNotification('Vul een dossiernummer in om op te slaan.', 'error');
                getEl('dossiernummer').classList.add('invalid-input');
                return;
            }
            getEl('dossiernummer').classList.remove('invalid-input');

            const data = {
                algemeen: { dossiernummer: getEl('dossiernummer').value, contactpersoon: getEl('contactpersoon').value, benadeelde: getEl('benadeelde').value, geboortedatum: getEl('geboortedatum').value, schadedatum: getEl('schadedatum').value },
                wederpartij: { verzekeraar: getEl('wederpartij-verzekeraar').value, contactpersoon: getEl('wederpartij-contactpersoon').value, schadenummer: getEl('wederpartij-schadenummer').value },
                instellingen: { rentePercentage: getEl('rente-percentage').value },
                totalen: { wettelijkeRente: getEl('wettelijke-rente').value, bgk: getEl('bgk').value, aansprakelijkheid: getEl('aansprakelijkheid').value, verrichteBetalingen: getEl('verrichte-betalingen').value },
                schadeposten: Array.from(document.querySelectorAll('#schade-schadeposten-lijst .schadepost-hoofd')).map(hoofdpost => ({
                    titel: hoofdpost.querySelector('.omschrijving-hoofd').value,
                    subRegels: Array.from(hoofdpost.querySelectorAll('.sub-regel')).map(regel => ({
                        datum: regel.querySelector('.datum').value, bewijsstuk: regel.querySelector('.bewijsstuk').value,
                        totaal: regel.querySelector('.bedrag-totaal').value, netto: regel.querySelector('.bedrag-netto').value,
                        btw: regel.querySelector('.bedrag-btw').value, toelichting: regel.querySelector('.toelichting').value,
                        rente: regel.querySelector('.rente-check').checked
                    }))
                }))
            };
            
            try {
                if (currentSchadestaatId) {
                    const schadestaatRef = doc(db, "schadestaten", currentSchadestaatId);
                    await updateDoc(schadestaatRef, { data: data, lastModified: serverTimestamp() });
                    showNotification(`Schadestaat '${dossiernummer}' bijgewerkt.`, 'success');
                } else {
                    const newDocRef = await addDoc(collection(db, "schadestaten"), { 
                        data: data, 
                        lastModified: serverTimestamp() 
                    });
                    currentSchadestaatId = newDocRef.id;
                    showNotification(`Schadestaat '${dossiernummer}' opgeslagen.`, 'success');
                }
                showPage('hub-page');
            } catch (error) {
                console.error("Fout bij opslaan schadestaat:", error);
                showNotification('Kon schadestaat niet opslaan.', 'error');
            }
        }

        getEl('save-data').addEventListener('click', saveData);

        function applyDataToForm(data) {
            schadepostenLijst.innerHTML = '';
            if (data.algemeen) Object.keys(data.algemeen).forEach(key => { const el = getEl(key); if (el) el.value = data.algemeen[key] || ''; });
            if (data.wederpartij) Object.keys(data.wederpartij).forEach(key => { const el = getEl(`wederpartij-${key}`); if (el) el.value = data.wederpartij[key] || ''; });
            if (data.instellingen?.rentePercentage) getEl('rente-percentage').value = data.instellingen.rentePercentage;
            if (data.totalen) Object.keys(data.totalen).forEach(key => { const el = getEl(key); if(el) el.value = data.totalen[key] || ''; });
            if (data.schadeposten) data.schadeposten.forEach(post => createSchadepost(post.titel, post.subRegels));

            berekenAutomatischeRente();
            berekenTotalen();
            scheduleValidation();
        }

        window.schadestaatApp = {
            loadState: (schadestaatId) => {
                const titleEl = document.getElementById('schadestaat-title');
                const formContainer = container.querySelector('.flex.flex-col.lg\\:flex-row');
                formContainer.querySelectorAll('input:not([type=button]):not([type=submit]), textarea').forEach(el => el.value = '');

                if (schadestaatId) {
                    currentSchadestaatId = schadestaatId;
                    const state = allSchadestaten.find(s => s.id === schadestaatId);
                    if (state) {
                        applyDataToForm(state.data);
                        const dossiernummer = state.data.algemeen?.dossiernummer;
                        titleEl.textContent = dossiernummer ? `Digitale Schadestaat - Dossier ${dossiernummer}` : 'Digitale Schadestaat';
                    } else {
                        currentSchadestaatId = null;
                        titleEl.textContent = 'Nieuwe Schadestaat';
                    }
                } else {
                    currentSchadestaatId = null;
                    titleEl.textContent = 'Nieuwe Schadestaat';
                    schadepostenLijst.innerHTML = '';
                    defaultSchadeposten.forEach(titel => createSchadepost(titel));
                    berekenTotalen();
                }
            }
        };

        getEl('export-excel').addEventListener('click', () => showNotification("Excel export functie is klaar voor gebruik.", "info"));
        getEl('print-export').addEventListener('click', () => showNotification("Print functie is klaar voor gebruik.", "info"));
    }

    // --- JURISPRUDENTIE SUPERZOEKER MODULE ---
    let jurisprudentieResults = [];
    let currentPage = 1;
    let totalResults = 0;
    const resultsPerPage = 20;
    
    // Data voor de geavanceerde filters
    const INSTANCES_DATA = [
        { name: 'Hoge Raad', value: 'HR' },
        { name: 'Raad van State', value: 'RVS' },
        { name: 'Centrale Raad van Beroep', value: 'CRVB' },
        { name: 'College van Beroep', value: 'CBB' },
        { name: 'Gerechtshoven', value: 'GERECHTSHOOF', children: [
            { name: 'Amsterdam', value: 'GHAMS' },
            { name: 'Den Haag', value: 'GHDHA' },
            { name: 'Arnhem-Leeuwarden', value: 'GHARL' },
            { name: '\'s-Hertogenbosch', value: 'GHSHE' }
        ]},
        { name: 'Rechtbanken', value: 'RECHTBANK', children: [
            { name: 'Amsterdam', value: 'RBAMS' },
            { name: 'Den Haag', value: 'RBDHA' },
            { name: 'Gelderland', value: 'RBGEL' },
            { name: 'Limburg', value: 'RBLIM' },
            { name: 'Midden-Nederland', value: 'RBMNE' },
            { name: 'Noord-Holland', value: 'RBNHO' },
            { name: 'Noord-Nederland', value: 'RBNNE' },
            { name: 'Oost-Brabant', value: 'RBOBR' },
            { name: 'Overijssel', value: 'RBOVE' },
            { name: 'Rotterdam', value: 'RBROT' },
            { name: 'Zeeland-West-Brabant', value: 'RBZWB' }
        ]}
    ];

    const LAW_AREAS_DATA = [
        { name: 'Bestuursrecht', value: 'bestuursrecht', children: [
            { name: 'Ambtenarenrecht', value: 'bestuursrecht/ambtenarenrecht' },
            { name: 'Belastingrecht', value: 'bestuursrecht/belastingrecht' },
            { name: 'Omgevingsrecht', value: 'bestuursrecht/omgevingsrecht' },
            { name: 'Socialezekerheidsrecht', value: 'bestuursrecht/socialezekerheidsrecht' },
            { name: 'Vreemdelingenrecht', value: 'bestuursrecht/vreemdelingenrecht' }
        ]},
        { name: 'Civiel recht', value: 'civiel', children: [
            { name: 'Aanbestedingsrecht', value: 'civiel/aanbestedingsrecht' },
            { name: 'Arbeidsrecht', value: 'civiel/arbeidsrecht' },
            { name: 'Burgerlijk procesrecht', value: 'civiel/burgerlijkprocesrecht' },
            { name: 'Insolventierecht', value: 'civiel/insolventierecht' },
            { name: 'Personen- en familierecht', value: 'civiel/personen-enfamilierecht' },
            { name: 'Verbintenissenrecht', value: 'civiel/verbintenissenrecht' }
        ]},
        { name: 'Internationaal', value: 'internationaal', children: [
            { name: 'Mensenrechten', value: 'internationaal/mensenrechten' },
            { name: 'Volkenrecht', value: 'internationaal/volkenrecht' },
        ]},
        { name: 'Strafrecht', value: 'strafrecht', children: [
            { name: 'Materieel strafrecht', value: 'strafrecht/materieelstrafrecht' },
            { name: 'Strafprocesrecht', value: 'strafrecht/strafprocesrecht' },
        ]}
    ];

    function createCheckbox(item, name) {
        return `
            <div class="text-sm">
                <label class="flex items-center">
                    <input type="checkbox" name="${name}" value="${item.value}" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                    <span class="ml-2">${item.name}</span>
                </label>
            </div>
        `;
    }

    function createFilterGroup(group, name) {
        const childrenHtml = group.children ? group.children.map(child => createCheckbox(child, name)).join('') : '';
        return `
            <div>
                <label class="font-semibold text-sm flex items-center">
                    <input type="checkbox" data-group-parent="${group.value}" name="${name}" value="${group.value}" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
                    <span class="ml-2">${group.name}</span>
                </label>
                <div class="pl-6 mt-1 space-y-1">
                    ${childrenHtml}
                </div>
            </div>
        `;
    }

    function populateFilters() {
        const instancesContainer = document.querySelector('#filter-details-instances .filter-checkbox-group');
        const lawAreasContainer = document.querySelector('#filter-details-law-areas .filter-checkbox-group');

        instancesContainer.innerHTML = INSTANCES_DATA.map(group => {
            return group.children ? createFilterGroup(group, 'filter-instance') : createCheckbox(group, 'filter-instance');
        }).join('');
        
        lawAreasContainer.innerHTML = LAW_AREAS_DATA.map(group => {
            return group.children ? createFilterGroup(group, 'filter-law-area') : createCheckbox(group, 'filter-law-area');
        }).join('');
    }
    
    function setupFilterListeners() {
        document.querySelectorAll('input[data-group-parent]').forEach(parentCheckbox => {
            parentCheckbox.addEventListener('change', (e) => {
                const groupContainer = e.target.closest('div');
                const childCheckboxes = groupContainer.querySelectorAll(`input[name="${e.target.name}"]:not([data-group-parent])`);
                childCheckboxes.forEach(child => {
                    child.checked = e.target.checked;
                });
            });
        });
    }

    function getSmartFilterValues(name, data) {
        const selectedValues = new Set();
        const form = document.getElementById('jurisprudentie-form');

        data.forEach(group => {
            const parentCheckbox = form.querySelector(`input[name="${name}"][value="${group.value}"]`);
            if (parentCheckbox && parentCheckbox.checked && group.children) {
                // Als de hoofdgroep is aangevinkt, voeg alleen die toe en sla kinderen over.
                selectedValues.add(group.value);
            } else if (group.children) {
                // Als de hoofdgroep niet is aangevinkt, controleer de kinderen.
                group.children.forEach(child => {
                    const childCheckbox = form.querySelector(`input[name="${name}"][value="${child.value}"]`);
                    if (childCheckbox && childCheckbox.checked) {
                        selectedValues.add(child.value);
                    }
                });
            } else if (parentCheckbox && parentCheckbox.checked) {
                // Voor items zonder kinderen (Hoge Raad, etc.)
                selectedValues.add(group.value);
            }
        });
        return Array.from(selectedValues);
    }

    function initializeJurisprudentieApp() {
        // Voorkom dat de filters en listeners opnieuw worden toegevoegd
        if (document.getElementById('jurisprudentie-form').dataset.initialized) return;

        populateFilters();
        
        const searchButton = document.getElementById('jurisprudentie-search-button');
        const resultsList = document.getElementById('jurisprudentie-results-list');
        const tabsContainer = document.getElementById('jurisprudentie-detail-tabs');
        const prevButton = document.getElementById('pagination-prev');
        const nextButton = document.getElementById('pagination-next');

        searchButton.addEventListener('click', () => {
            currentPage = 1;
            handleJurisprudentieSearch();
        });
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                handleJurisprudentieSearch();
            }
        });
        nextButton.addEventListener('click', () => {
            const totalPages = Math.ceil(totalResults / resultsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                handleJurisprudentieSearch();
            }
        });
        
        setupFilterListeners();
        resultsList.addEventListener('click', handleResultClick);
        tabsContainer.addEventListener('click', handleTabClick);

        document.getElementById('jurisprudentie-form').dataset.initialized = 'true';
    }

    async function handleJurisprudentieSearch() {
        const omnibox = document.getElementById('jurisprudentie-omnibox');
        const resultsList = document.getElementById('jurisprudentie-results-list');
        const resultCount = document.getElementById('jurisprudentie-result-count');
        const loader = document.getElementById('jurisprudentie-loader-container');
        const searchButton = document.getElementById('jurisprudentie-search-button');

        const searchTerm = omnibox.value.trim();
        if (!searchTerm) {
            showNotification('Voer een zoekterm in.', 'error');
            return;
        }

        loader.classList.remove('hidden');
        searchButton.disabled = true;
        searchButton.textContent = 'Bezig...';
        
        resultsList.innerHTML = '';
        resultCount.textContent = '...';
        document.getElementById('jurisprudentie-detail-pane-placeholder').classList.remove('hidden');
        document.getElementById('jurisprudentie-detail-pane-content').classList.add('hidden');
        updatePaginationUI();
        
        // *** GEBRUIK DE NIEUWE SLIMME FILTER LOGICA ***
        const requestBody = {
            query: searchTerm,
            dateStart: document.getElementById('filter-date-start').value,
            dateEnd: document.getElementById('filter-date-end').value,
            instances: getSmartFilterValues('filter-instance', INSTANCES_DATA),
            lawAreas: getSmartFilterValues('filter-law-area', LAW_AREAS_DATA),
            page: currentPage
        };

        try {
            const response = await fetch('/.netlify/functions/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("Server error details:", errorData.error);
                throw new Error(`Serverfout: ${response.status}.`);
            }

            const data = await response.json();
            jurisprudentieResults = data.results || [];
            totalResults = data.total || 0;

            resultCount.textContent = totalResults;
            if (jurisprudentieResults.length > 0) {
                resultsList.innerHTML = jurisprudentieResults.map(createResultCard).join('');
            } else {
                resultsList.innerHTML = `<div class="text-center p-10 text-gray-500">Geen resultaten gevonden voor deze zoekopdracht.</div>`;
            }
        } catch (error) {
            console.error('Fout bij het zoeken:', error);
            resultsList.innerHTML = `<div class="text-center p-10 text-red-500">Er is een fout opgetreden. Probeer het opnieuw.</div>`;
            showNotification(`Zoekopdracht mislukt: ${error.message}`, 'error');
            totalResults = 0;
        } finally {
            loader.classList.add('hidden');
            searchButton.disabled = false;
            searchButton.textContent = 'Zoeken';
            updatePaginationUI();
        }
    }
    
    function updatePaginationUI() {
        const paginationContainer = document.getElementById('jurisprudentie-pagination');
        const prevButton = document.getElementById('pagination-prev');
        const nextButton = document.getElementById('pagination-next');
        const pageInfo = document.getElementById('pagination-info');

        if (totalResults === 0) {
            paginationContainer.classList.add('hidden');
            return;
        }
        
        paginationContainer.classList.remove('hidden');

        const totalPages = Math.ceil(totalResults / resultsPerPage);
        const startItem = (currentPage - 1) * resultsPerPage + 1;
        const endItem = Math.min(currentPage * resultsPerPage, totalResults);
        
        pageInfo.textContent = `${startItem}-${endItem} van ${totalResults}`;
        
        prevButton.disabled = currentPage === 1;
        nextButton.disabled = currentPage >= totalPages;
    }

    function createResultCard(result) {
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('nl-NL', { year: 'numeric', month: 'long', day: 'numeric' });
        return `
            <div class="p-3 border rounded-md hover:bg-subtle hover:shadow-md cursor-pointer jurisprudentie-result-item border-l-4 border-transparent" data-id="${result.id}">
                <h4 class="font-semibold text-primary text-md">${sanitizeInput(result.title)}</h4>
                <div class="text-xs text-gray-500 mt-1">
                    <span>${sanitizeInput(result.id)}</span> | <span>${formatDate(result.updated)}</span>
                </div>
            </div>`;
    }

    function handleResultClick(e) {
        const resultItem = e.target.closest('.jurisprudentie-result-item');
        if (!resultItem) return;

        const resultId = resultItem.dataset.id;
        
        document.querySelectorAll('.jurisprudentie-result-item').forEach(el => el.classList.remove('result-item-selected'));
        resultItem.classList.add('result-item-selected');

        document.getElementById('jurisprudentie-detail-pane-placeholder').classList.add('hidden');
        const detailPane = document.getElementById('jurisprudentie-detail-pane-content');
        detailPane.classList.remove('hidden');
        detailPane.classList.add('flex');

        renderDetailTabs(resultId, 'summary');
    }
    
    function handleTabClick(e) {
        const tabButton = e.target.closest('.jurisprudentie-tab-button');
        if (!tabButton) return;
        
        const resultId = tabButton.dataset.resultId;
        const tabId = tabButton.dataset.tabId;
        
        renderDetailTabs(resultId, tabId);
    }
    
    function renderDetailTabs(resultId, activeTabId = 'summary') {
        const resultData = jurisprudentieResults.find(r => r.id === resultId);
        if (!resultData) return;
        
        const tabsContainer = document.getElementById('jurisprudentie-detail-tabs');
        const tabContentContainer = document.getElementById('jurisprudentie-detail-tab-content');

        const tabs = [
            { id: 'summary', name: 'Samenvatting' },
            { id: 'details', name: 'Details' },
            { id: 'link', name: 'Origineel' },
        ];

        tabsContainer.innerHTML = tabs.map(tab => {
            const isActive = tab.id === activeTabId;
            const classes = isActive ? 'border-primary text-primary font-semibold' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            return `<button data-tab-id="${tab.id}" data-result-id="${resultId}" class="jurisprudentie-tab-button whitespace-nowrap py-3 px-1 border-b-2 text-sm ${classes}">${tab.name}</button>`;
        }).join('');

        let content = '';
        switch(activeTabId) {
            case 'summary':
                content = `
                    <div class="space-y-4">
                        <h3 class="text-lg font-bold text-primary">${sanitizeInput(resultData.title)}</h3>
                        <div class="prose prose-sm max-w-none bg-subtle p-3 rounded-md border">
                            ${resultData.summary ? sanitizeInput(resultData.summary).replace(/\n/g, '<br>') : '<i>Geen samenvatting beschikbaar.</i>'}
                        </div>
                    </div>`;
                break;
            case 'details':
                const formattedDate = new Date(resultData.updated).toLocaleString('nl-NL', { dateStyle: 'full', timeStyle: 'short'});
                content = `
                    <div class="space-y-2 text-sm">
                        <div class="flex"><strong class="w-28 flex-shrink-0">ECLI:</strong><span>${sanitizeInput(resultData.id)}</span></div>
                        <div class="flex"><strong class="w-28 flex-shrink-0">Laatst bijgewerkt:</strong><span>${formattedDate}</span></div>
                        <div class="flex"><strong class="w-28 flex-shrink-0">Bron:</strong><span>Rechtspraak.nl</span></div>
                    </div>`;
                break;
            case 'link':
                content = `<p>Klik op de link om de originele uitspraak direct op Rechtspraak.nl te bekijken:</p>
                           <a href="${resultData.link}" target="_blank" rel="noopener noreferrer" class="text-primary font-semibold hover:underline break-all">${resultData.link}</a>`;
                break;
        }
        tabContentContainer.innerHTML = content;
    }

</script>
</body>
</html>
